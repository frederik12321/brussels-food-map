<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brussels Food Map - Hidden Gems</title>
    <!-- Preconnect for faster resource loading -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cartodb-basemaps-a.global.ssl.fastly.net" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            /* Modern minimal palette */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-elevated: #ffffff;
            --bg-hover: #f4f4f5;
            --bg-sidebar: #fafafa;

            /* Border colors */
            --border-subtle: #e4e4e7;
            --border-default: #d4d4d8;
            --border-focus: #18181b;

            /* Text colors */
            --text-primary: #18181b;
            --text-secondary: #71717a;
            --text-muted: #a1a1aa;

            /* Accent colors - modern vibrant */
            --accent-green: #22c55e;
            --accent-green-light: #4ade80;
            --accent-orange: #f97316;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-primary: #18181b;

            /* Shadows - modern soft */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Border radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 400px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 100vh;
        }

        .header {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            box-shadow: var(--shadow-md);
        }

        .header-text h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header-text p {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 16px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .stat {
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            font-weight: 500;
        }

        .filters {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            flex: 1;
        }

        .filter-group.full-width {
            flex: none;
            width: 100%;
        }

        .filter-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-normal);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(24, 24, 27, 0.08);
        }

        select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%2371717a' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(24, 24, 27, 0.08);
        }

        .toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            min-width: 70px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--accent-primary);
            color: white;
            font-weight: 500;
            border-color: var(--accent-primary);
        }

        .results {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 16px 24px;
            background: var(--bg-secondary);
            min-height: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .results-count {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .restaurant-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .restaurant-card:hover {
            border-color: var(--border-default);
            box-shadow: var(--shadow-md);
        }

        .restaurant-card:active {
            transform: scale(0.995);
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .restaurant-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.3;
        }

        .restaurant-badges {
            display: flex;
            gap: 6px;
            margin-left: 8px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-score {
            background: var(--accent-green);
            color: white;
        }

        .badge-underexplored {
            background: var(--accent-purple);
            color: white;
        }

        .restaurant-location {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .restaurant-cuisine {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .restaurant-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #fbbc04;
        }

        .restaurant-hours {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
            font-size: 12px;
            color: var(--text-muted);
        }

        .restaurant-hours-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hours-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .hours-status-dot.open {
            background: var(--accent-green);
        }

        .hours-status-dot.closed {
            background: var(--accent-red);
        }

        .hours-status-dot.unknown {
            background: var(--text-muted);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-legend {
            position: absolute;
            bottom: 24px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            z-index: 1000;
            font-size: 12px;
            box-shadow: var(--shadow-lg);
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: var(--radius-sm);
        }

        /* Info button */
        .info-btn {
            position: absolute;
            top: 70px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .info-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Info popup overlay */
        .info-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .info-overlay.active {
            display: flex;
        }

        .info-popup {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .info-popup h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .info-popup .info-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-popup .info-icon {
            font-size: 16px;
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .info-popup .info-text {
            color: var(--text-secondary);
        }

        .info-popup .info-text strong {
            color: var(--text-primary);
        }

        .info-popup hr {
            border: none;
            border-top: 1px solid var(--border-subtle);
            margin: 16px 0;
        }

        .info-popup .info-icons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-popup .info-icons span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-popup .info-icons .icon-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .info-close {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .info-close:hover {
            background: #27272a;
        }

        .info-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
            font-size: 12px;
        }

        .info-footer a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .info-footer a:hover {
            color: var(--text-primary);
        }

        .info-footer span {
            color: var(--text-muted);
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .leaflet-popup-content {
            color: var(--text-primary);
            margin: 14px;
            font-size: 13px;
        }

        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }

        .popup-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .popup-commune {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .popup-cuisine {
            color: var(--accent-blue);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .popup-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px 14px;
            background: var(--accent-primary);
            border-radius: var(--radius-md);
            color: white;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-normal);
        }

        .popup-link:hover {
            background: #27272a;
            text-decoration: none;
        }

        .popup-hours {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .popup-hours-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .popup-hours-header:hover {
            color: var(--text-primary);
        }

        .popup-hours-toggle {
            font-size: 10px;
            transition: transform var(--transition-fast);
        }

        .popup-hours-toggle.expanded {
            transform: rotate(90deg);
        }

        .popup-hours-list {
            display: none;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .popup-hours-list.show {
            display: block;
        }

        .popup-hours-list div {
            padding: 2px 0;
        }

        .popup-hours-list .today {
            color: var(--accent-green);
            font-weight: 500;
        }

        .popup-hours-list .closed {
            color: var(--accent-red);
        }

        /* Diaspora context info */
        .popup-diaspora {
            margin-top: 10px;
            padding: 8px 10px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--radius-sm);
            font-size: 11px;
            color: #92400e;
        }

        .popup-diaspora-header {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .popup-diaspora-streets {
            font-size: 10px;
            color: #a16207;
            margin-top: 4px;
        }

        .popup-diaspora-desc {
            font-size: 10px;
            color: #a16207;
            margin-top: 4px;
            font-style: italic;
        }

        /* Guide recognition badges */
        .guide-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .guide-badge.michelin {
            background: #dc2626;
            color: white;
        }

        .guide-badge.michelin-2 {
            background: linear-gradient(135deg, #fbbf24 0%, #dc2626 100%);
            color: white;
        }

        .guide-badge.bib-gourmand {
            background: #dc2626;
            color: white;
            font-size: 9px;
        }

        .guide-badge.gault-millau {
            background: var(--text-primary);
            color: #fbbf24;
        }

        .guide-badge.reddit {
            background: #ff4500;
            color: white;
        }

        .guide-badges {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .popup-explanation {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
            font-size: 12px;
            line-height: 1.5;
        }

        .explain-title {
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .methodology-link {
            text-transform: none;
            font-weight: 500;
            font-size: 10px;
            color: #2563eb;
            text-decoration: none;
            flex-shrink: 0;
        }

        .methodology-link:hover {
            text-decoration: underline;
        }

        .explain-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .explain-icon {
            flex-shrink: 0;
            width: 18px;
            text-align: center;
        }

        .explain-text {
            flex: 1;
            line-height: 1.4;
        }

        .explain-positive {
            color: var(--accent-green);
        }

        .explain-positive .explain-text {
            color: var(--text-primary);
        }

        .explain-negative {
            color: var(--accent-red);
        }

        .explain-negative .explain-text {
            color: var(--text-primary);
        }

        .explain-neutral {
            color: var(--accent-orange);
        }

        .explain-neutral .explain-text {
            color: var(--text-primary);
        }

        /* Collapsible details */
        .explain-more {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-subtle);
        }

        .explain-more.expanded {
            display: block;
        }

        .explain-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--accent-blue);
            background: none;
            border: 1px solid var(--accent-blue);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .explain-toggle:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Score factors - compact pills showing what contributes to score */
        .score-factors {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .factors-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .factors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .score-factor {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
            cursor: help;
            white-space: nowrap;
        }

        .factor-neutral {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .factor-highlight {
            background: #dcfce7;
            color: #166534;
        }

        .factor-negative {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .popup-explanation {
                font-size: 11px;
            }

            .explain-item {
                font-size: 11px;
            }
        }

        .commune-label {
            background: transparent !important;
            border: none !important;
            pointer-events: none;
        }

        .pin-marker {
            background: transparent !important;
            border: none !important;
        }

        .pin-marker svg {
            transition: transform 0.25s ease-out;
        }

        .pin-dot:hover svg {
            transform: scale(1.3);
        }

        .pin-selected svg {
            transform-origin: bottom center;
        }

        .commune-label div {
            text-align: center;
            letter-spacing: 0.5px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #666;
            font-size: 13px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
            }

            .map-container {
                height: 50vh;
                min-height: 300px;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                padding: 12px 16px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 9px;
            }

            .filters {
                padding: 12px 16px;
            }

            .filter-row {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 12px;
            }

            .results {
                padding: 12px 16px;
                touch-action: pan-y;
            }

            .restaurant-card {
                padding: 12px;
            }

            .toggle-btn {
                min-width: 70px;
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .toggle-group {
                flex-wrap: wrap;
            }

            .toggle-btn {
                flex: 1 1 45%;
            }
        }

        /* Disable heavy transitions on mobile for snappier UX */
        @media (max-width: 768px) {
            .restaurant-card,
            .toggle-btn,
            select,
            .search-input {
                transition: none !important;
            }

            .restaurant-card:hover {
                transform: none;
            }
        }

        /* Mobile tab navigation */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-subtle);
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .mobile-tabs-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .mobile-tab.active {
            color: var(--accent-primary);
        }

        .mobile-tab-icon {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .mobile-tabs {
                display: block;
            }

            /* Hide old toggle button */
            .mobile-toggle {
                display: none !important;
            }

            /* Tab: Map */
            .container.tab-map .sidebar {
                display: none;
            }

            .container.tab-map .map-container {
                height: calc(100vh - 70px);
                height: calc(100dvh - 70px);
            }

            .container.tab-map .map-legend {
                bottom: 80px;
            }

            /* Tab: Search */
            .container.tab-search .map-container {
                display: none !important;
            }

            .container.tab-search .sidebar {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 70px !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
                background: #FDF6E3 !important;
                border: none !important;
            }

            .container.tab-search .header {
                display: block !important;
                padding: 16px !important;
            }

            .container.tab-search .header-logo {
                width: 80px !important;
                height: 80px !important;
            }

            .container.tab-search .header-text h1 {
                font-size: 22px !important;
            }

            .container.tab-search .stats {
                display: none !important;
            }

            .container.tab-search .filters {
                display: block !important;
                padding: 12px 16px;
                padding-bottom: 40px;
                overflow: visible !important;
                max-height: none !important;
                border: none !important;
            }

            .container.tab-search .filters .filter-row {
                flex-direction: column;
                gap: 12px;
            }

            .container.tab-search .results {
                display: none !important;
            }

            /* Tab: Results */
            .container.tab-results .map-container {
                display: none !important;
            }

            .container.tab-results .sidebar {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 70px !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
                background: #EDE0D4 !important;
                border: none !important;
            }

            .container.tab-results .header {
                display: block !important;
                padding: 16px !important;
            }

            .container.tab-results .header-logo {
                width: 80px !important;
                height: 80px !important;
            }

            .container.tab-results .header-text h1 {
                font-size: 22px !important;
            }

            .container.tab-results .stats,
            .container.tab-results .filters {
                display: none !important;
            }

            .container.tab-results .results {
                display: block !important;
                padding: 12px 16px;
                padding-bottom: 40px;
                overflow: visible !important;
                max-height: none !important;
                background: transparent !important;
            }

            /* Hide legend in non-map tabs, but keep info button visible */
            .container.tab-search .map-legend,
            .container.tab-results .map-legend {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <div class="header-content">
                    <img src="/static/logo.jpg" alt="Brussels Food Map" class="header-logo">
                    <div class="header-text">
                        <h1>Brussels Food Map</h1>
                        <p>Discover hidden gems</p>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="total-restaurants">-</div>
                    <div class="stat-label">Restaurants</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-communes">19</div>
                    <div class="stat-label">Communes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-gems">-</div>
                    <div class="stat-label">Top Picks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-cuisines">-</div>
                    <div class="stat-label">Cuisines</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group full-width">
                    <label class="filter-label">Search</label>
                    <input type="text" class="search-input" id="search" placeholder="Restaurant name...">
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Commune</label>
                        <select id="commune-filter">
                            <option value="all">All Communes</option>
                            {% for commune in communes %}
                            <option value="{{ commune }}">{{ commune }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Cuisine</label>
                        <select id="cuisine-filter">
                            <option value="all">All Cuisines</option>
                            {% for cuisine in cuisines %}
                            <option value="{{ cuisine }}">{{ cuisine }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Venue Type</label>
                        <select id="venue-filter">
                            <option value="all">All Venues</option>
                            <option value="Restaurant" selected>Restaurants Only</option>
                            <option value="Sandwich_shop">Sandwich Shops</option>
                            <option value="Fast_food">Fast Food</option>
                            <option value="Cafe">Cafes</option>
                            <option value="Bar">Bars</option>
                            <option value="Bakery">Bakeries</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Rating</label>
                        <select id="rating-filter">
                            <option value="">Any</option>
                            <option value="3.5">3.5+</option>
                            <option value="4.0">4.0+</option>
                            <option value="4.5">4.5+</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Price</label>
                        <select id="price-filter">
                            <option value="">Any</option>
                            <option value="1">‚Ç¨ (Budget)</option>
                            <option value="2">‚Ç¨‚Ç¨ (Moderate)</option>
                            <option value="3">‚Ç¨‚Ç¨‚Ç¨ (Expensive)</option>
                            <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Fine Dining)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sort-filter">
                            <option value="brussels_score">Brussels Score</option>
                            <option value="rating">Rating</option>
                            <option value="residual">Undervalued</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Open On</label>
                        <select id="day-filter">
                            <option value="">Any Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Open At</label>
                        <select id="time-filter">
                            <option value="">Any Time</option>
                            <option value="12">12:00 (Lunch)</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00 (Dinner)</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00 (Late)</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Recognition</label>
                        <select id="guide-filter">
                            <option value="">Any</option>
                            <option value="michelin">Michelin Stars</option>
                            <option value="bib">Bib Gourmand</option>
                            <option value="gaultmillau">Gault & Millau</option>
                            <option value="reddit">r/brussels Approved</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group full-width">
                    <label class="filter-label">Show</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" id="show-all" title="Show all restaurants matching your filters">All</button>
                        <button class="toggle-btn" id="show-brussels-gems" title="Top 100 overall: combines quality, local appeal, scarcity & guide recognition">üèÜ Top 100</button>
                    </div>
                </div>
            </div>

            <div class="results">
                <div class="results-header">
                    <span class="results-count" id="results-count">Loading...</span>
                </div>
                <div id="restaurant-list">
                    <div class="loading">Loading restaurants...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <button class="mobile-toggle" id="mobile-toggle" style="display:none;">Show Map</button>

        <!-- Mobile Tab Navigation -->
        <div class="mobile-tabs">
            <div class="mobile-tabs-inner">
                <button class="mobile-tab active" data-tab="map">
                    <span class="mobile-tab-icon">üó∫Ô∏è</span>
                    <span>Map</span>
                </button>
                <button class="mobile-tab" data-tab="search">
                    <span class="mobile-tab-icon">üîç</span>
                    <span>Search</span>
                </button>
                <button class="mobile-tab" data-tab="results">
                    <span class="mobile-tab-icon">üìã</span>
                    <span>Results</span>
                </button>
            </div>
        </div>
        <button class="info-btn" id="info-btn">i</button>
        <div class="map-legend" id="legend-markers">
                <div class="legend-title">Brussels Food Map</div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#FFD700"/>
                        <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                        <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                    </svg>
                    <span>Chef's Kiss</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#2ECC71"/>
                        <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                    </svg>
                    <span>Kitchen Approved</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#3498DB"/>
                        <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                    </svg>
                    <span>Workable</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#95A5A6"/>
                        <circle cx="9" cy="9" r="2.5" fill="white"/>
                    </svg>
                    <span>Line Cook Shrug</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Popup Overlay -->
    <div class="info-overlay" id="info-overlay">
        <div class="info-popup">
            <h3>Brussels Food Map</h3>
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px; line-height: 1.5;">Find the best restaurants in Brussels. We re-rank Google ratings to surface local gems and filter out tourist traps.</p>

            <div class="info-icons" style="margin-bottom: 16px;">
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#FFD700"/>
                        <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                        <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                    </svg>
                    Chef's Kiss
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#2ECC71"/>
                        <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                    </svg>
                    Kitchen Approved
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#3498DB"/>
                        <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                    </svg>
                    Workable
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#95A5A6"/>
                        <circle cx="9" cy="9" r="2.5" fill="white"/>
                    </svg>
                    Line Cook Shrug
                </span>
            </div>

            <a href="/methodology" target="_blank" style="display: block; text-align: center; color: #2563eb; font-size: 13px; margin-bottom: 16px;">How do we rank restaurants?</a>

            <button class="info-close" id="info-close">Got it</button>
            <div class="info-footer">
                <a href="/privacy" target="_blank">Privacy</a>
                <span>¬∑</span>
                <a href="/terms" target="_blank">Terms</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Brussels - optimized for mobile
        const isMobile = window.innerWidth <= 768;
        const map = L.map('map', {
            zoomControl: false,
            // Disable animations on mobile for snappier feel
            zoomAnimation: !isMobile,
            fadeAnimation: !isMobile,
            markerZoomAnimation: !isMobile,
            // Faster touch response
            tap: true,
            tapTolerance: 15,
            touchZoom: 'center',
            bounceAtZoomLimits: false
        }).setView([50.8503, 4.3517], 13);

        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        // Use CartoDB Voyager for clean Google Maps-like appearance
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19,
            // Better tile loading on mobile
            updateWhenIdle: isMobile,
            updateWhenZooming: false,
            keepBuffer: isMobile ? 2 : 4
        }).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);
        let hexagonsLayer = L.layerGroup();
        let communeLabelsLayer = L.layerGroup().addTo(map);

        // Brussels commune centers for labels
        const communeLabels = [
            { name: "Bruxelles", lat: 50.8467, lng: 4.3517, tier: "tourist_heavy" },
            { name: "Ixelles", lat: 50.8275, lng: 4.3697, tier: "mixed" },
            { name: "Saint-Gilles", lat: 50.8261, lng: 4.3456, tier: "diaspora_hub" },
            { name: "Etterbeek", lat: 50.8333, lng: 4.3833, tier: "eu_bubble" },
            { name: "Schaerbeek", lat: 50.8653, lng: 4.3778, tier: "diaspora_hub" },
            { name: "Anderlecht", lat: 50.8333, lng: 4.3072, tier: "underexplored" },
            { name: "Molenbeek", lat: 50.8547, lng: 4.3286, tier: "diaspora_hub" },
            { name: "Saint-Josse", lat: 50.8553, lng: 4.3703, tier: "diaspora_hub" },
            { name: "Uccle", lat: 50.8000, lng: 4.3333, tier: "local_foodie" },
            { name: "Forest", lat: 50.8103, lng: 4.3242, tier: "underexplored" },
            { name: "Woluwe-St-Lambert", lat: 50.8417, lng: 4.4333, tier: "local_foodie" },
            { name: "Woluwe-St-Pierre", lat: 50.8333, lng: 4.4500, tier: "local_foodie" },
            { name: "Auderghem", lat: 50.8167, lng: 4.4333, tier: "local_foodie" },
            { name: "Watermael", lat: 50.7958, lng: 4.4125, tier: "local_foodie" },
            { name: "Evere", lat: 50.8667, lng: 4.4000, tier: "underexplored" },
            { name: "Jette", lat: 50.8792, lng: 4.3250, tier: "underexplored" },
            { name: "Ganshoren", lat: 50.8750, lng: 4.3083, tier: "underexplored" },
            { name: "Koekelberg", lat: 50.8625, lng: 4.3292, tier: "underexplored" },
            { name: "Berchem", lat: 50.8667, lng: 4.2917, tier: "underexplored" }
        ];

        // Add commune labels to map
        function addCommuneLabels() {
            communeLabelsLayer.clearLayers();

            communeLabels.forEach(commune => {
                const tierColors = {
                    'tourist_heavy': '#f87171',
                    'diaspora_hub': '#f59e0b',
                    'local_foodie': '#4ade80',
                    'underexplored': '#a78bfa',
                    'eu_bubble': '#60a5fa',
                    'mixed': '#94a3b8'
                };
                const color = tierColors[commune.tier] || '#888';

                const label = L.divIcon({
                    className: 'commune-label',
                    html: `<div style="color: #5f6368; text-shadow: 0 1px 2px rgba(255,255,255,0.9), 0 0 4px rgba(255,255,255,0.8); font-weight: 500; font-size: 11px; white-space: nowrap; text-transform: uppercase; letter-spacing: 1px;">${commune.name}</div>`,
                    iconSize: [140, 24],
                    iconAnchor: [70, 12]
                });

                L.marker([commune.lat, commune.lng], { icon: label, interactive: false })
                    .addTo(communeLabelsLayer);
            });
        }

        // Show/hide labels based on zoom level
        map.on('zoomend', function() {
            const zoom = map.getZoom();
            if (zoom >= 12 && zoom <= 15) {
                if (!map.hasLayer(communeLabelsLayer)) {
                    communeLabelsLayer.addTo(map);
                }
            } else if (zoom < 12) {
                if (map.hasLayer(communeLabelsLayer)) {
                    map.removeLayer(communeLabelsLayer);
                }
            }
        });

        addCommuneLabels();

        let restaurants = [];
        let currentFilter = 'all';

        // Day names to match opening_hours format
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function getTodayIndex() {
            return new Date().getDay(); // 0 = Sunday
        }

        function generateHoursHtml(openingHours) {
            if (!openingHours || openingHours.length === 0) {
                return '';
            }

            const todayIndex = getTodayIndex();
            const todayName = dayNames[todayIndex];

            // Find today's hours
            let todayHours = openingHours.find(h => h && h.startsWith(todayName));
            let statusText = 'Hours unknown';
            let statusClass = 'unknown';

            if (todayHours) {
                const hoursPart = todayHours.split(': ')[1] || '';
                if (hoursPart.toLowerCase().includes('closed')) {
                    statusText = 'Closed today';
                    statusClass = 'closed';
                } else {
                    statusText = `Today: ${hoursPart}`;
                    statusClass = 'open';
                }
            }

            // Build the hours list with today highlighted
            const hoursListHtml = openingHours.map(h => {
                if (!h) return '';
                const isToday = h.startsWith(todayName);
                const isClosed = h.toLowerCase().includes('closed');
                let classes = [];
                if (isToday) classes.push('today');
                if (isClosed) classes.push('closed');
                return `<div class="${classes.join(' ')}">${h}</div>`;
            }).join('');

            return `
                <div class="popup-hours">
                    <div class="popup-hours-header" onclick="toggleHours(this)">
                        <span class="popup-hours-toggle">‚ñ∂</span>
                        <span class="hours-status-dot ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                    <div class="popup-hours-list">
                        ${hoursListHtml}
                    </div>
                </div>
            `;
        }

        function toggleHours(header) {
            const toggle = header.querySelector('.popup-hours-toggle');
            const list = header.nextElementSibling;
            toggle.classList.toggle('expanded');
            list.classList.toggle('show');
        }

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getOpenStatus(openingHours) {
            if (!openingHours || openingHours.length === 0) {
                return { status: 'unknown', text: '' };
            }

            const todayIndex = getTodayIndex();
            const todayName = dayNames[todayIndex];
            const todayHours = openingHours.find(h => h && h.startsWith(todayName));

            if (!todayHours) {
                return { status: 'unknown', text: '' };
            }

            const hoursPart = todayHours.split(': ')[1] || '';
            if (hoursPart.toLowerCase().includes('closed')) {
                return { status: 'closed', text: 'Closed today' };
            }

            return { status: 'open', text: hoursPart };
        }

        function getMarkerColor(restaurant) {
            const score = restaurant.brussels_score || 0;
            // Based on percentile distribution for meaningful differentiation:
            // Top 5% (>=0.64), Top 15% (>=0.56), Top 35% (>=0.45), Top 75% (>=0.25)
            if (score >= 0.64) return '#059669';  // Emerald - top 5% (must try)
            if (score >= 0.56) return '#10b981';  // Green - top 15% (recommended)
            if (score >= 0.45) return '#6366f1';  // Indigo - top 35% (above average)
            if (score >= 0.25) return '#94a3b8';  // Slate gray - top 75% (average)
            return '#64748b';  // Dark slate - bottom 25% (below average)
        }

        function getHexColor(cluster) {
            const colors = {
                'Elite': '#4ade80',
                'Strong': '#60a5fa',
                'Everyday': '#fbbf24',
                'Emerging': '#a78bfa'
            };
            return colors[cluster] || '#666';
        }

        function getScoreExplanation(restaurant) {
            const primary = [];   // Most important - always show (max 2)
            const secondary = []; // Show in expanded view

            // === PRIMARY EXPLANATIONS (user-friendly language) ===

            // 1. Hidden gem / Underrated (most valuable insight)
            if (restaurant.residual !== undefined && restaurant.residual !== null) {
                const residualStars = restaurant.residual.toFixed(1);
                if (restaurant.residual > 0.25) {
                    primary.push({
                        icon: 'üíé',
                        text: `Hidden gem ‚Äî +${residualStars}‚òÖ above expected`,
                        type: 'positive'
                    });
                } else if (restaurant.residual > 0.1) {
                    primary.push({
                        icon: '‚úì',
                        text: `Outperforms peers by +${residualStars}‚òÖ`,
                        type: 'positive'
                    });
                } else if (restaurant.residual < -0.2) {
                    secondary.push({
                        icon: '‚ö†Ô∏è',
                        text: `${residualStars}‚òÖ below expected ‚Äî rating may be inflated`,
                        type: 'negative'
                    });
                }
            }

            // 2. Reddit community endorsement (social proof)
            if (restaurant.reddit_mentions && restaurant.reddit_mentions >= 2) {
                const item = {
                    icon: 'üî•',
                    text: restaurant.reddit_mentions >= 5
                        ? `Local favorite ‚Äî mentioned ${restaurant.reddit_mentions}x on r/brussels`
                        : `Recommended by r/brussels community`,
                    type: 'positive',
                    style: 'color: #FF4500;'
                };
                primary.push(item);
            }

            // 3. Guide recognition (authoritative)
            if (restaurant.michelin_stars || restaurant.bib_gourmand || restaurant.gault_millau) {
                // Already shown as badges, but add context
                if (restaurant.michelin_stars >= 1) {
                    primary.push({
                        icon: '‚≠ê',
                        text: `Michelin ${restaurant.michelin_stars > 1 ? restaurant.michelin_stars + ' stars' : 'starred'} ‚Äî exceptional quality`,
                        type: 'positive'
                    });
                } else if (restaurant.bib_gourmand) {
                    primary.push({
                        icon: 'üçΩÔ∏è',
                        text: 'Bib Gourmand ‚Äî great value for money',
                        type: 'positive'
                    });
                }
            }

            // 4. Scarcity signals (indicates authenticity)
            if (restaurant.score_scarcity_bonus > 0.02) {
                const scarcityParts = [];

                if (restaurant.closes_early && restaurant.typical_close_hour) {
                    if (restaurant.typical_close_hour <= 16) {
                        scarcityParts.push("lunch only");
                    } else if (restaurant.typical_close_hour <= 20) {
                        scarcityParts.push(`closes early`);
                    }
                }

                if (restaurant.days_open_count && restaurant.days_open_count <= 5) {
                    scarcityParts.push(`limited hours`);
                }

                if (restaurant.is_rare_cuisine) {
                    scarcityParts.push("rare cuisine");
                }

                if (scarcityParts.length > 0) {
                    const isExclusive = restaurant.score_scarcity_bonus > 0.08;
                    primary.push({
                        icon: isExclusive ? 'üîí' : '‚ú®',
                        text: isExclusive
                            ? `Exclusive ‚Äî ${scarcityParts.join(", ")} (plan ahead)`
                            : `${scarcityParts.join(", ").charAt(0).toUpperCase() + scarcityParts.join(", ").slice(1)} ‚Äî worth the effort`,
                        type: 'positive'
                    });
                } else if (restaurant.rating >= 4.5 && restaurant.review_count <= 300) {
                    primary.push({
                        icon: 'üîí',
                        text: 'Under the radar ‚Äî quality without the crowds',
                        type: 'positive'
                    });
                }
            }

            // 5. Diaspora street bonus
            if (restaurant.diaspora_street) {
                secondary.push({
                    icon: 'üìç',
                    text: `${restaurant.diaspora_street} ‚Äî diaspora food street`,
                    type: 'positive'
                });
            }

            // === SECONDARY EXPLANATIONS (show in "more details") ===

            // Area context
            if (restaurant.score_tourist_penalty !== undefined && restaurant.score_tourist_penalty < -0.05) {
                secondary.push({
                    icon: 'üìç',
                    text: 'Tourist area ‚Äî can be crowded',
                    type: 'neutral'
                });
            }

            if (restaurant.commune_tier) {
                if (restaurant.commune_tier === 'underexplored') {
                    secondary.push({
                        icon: 'üîç',
                        text: 'Off the beaten path ‚Äî authentic neighborhood',
                        type: 'positive'
                    });
                } else if (restaurant.commune_tier === 'tourist_trap') {
                    // Already covered by tourist penalty
                } else if (restaurant.commune_tier === 'eu_bubble') {
                    secondary.push({
                        icon: 'üá™üá∫',
                        text: 'EU quarter ‚Äî international crowd',
                        type: 'neutral'
                    });
                }
            }

            // New/promising
            if (restaurant.review_count && restaurant.review_count < 50 && restaurant.rating >= 4.5) {
                secondary.push({
                    icon: 'üÜï',
                    text: `New discovery ‚Äî early reviews are positive`,
                    type: 'positive'
                });
            }

            // Chain warning (only negative, not positive for independent)
            if (restaurant.is_chain === true || restaurant.is_chain === 1) {
                secondary.push({
                    icon: 'üîó',
                    text: 'Chain restaurant',
                    type: 'negative'
                });
            }

            // Popular despite high volume
            if (restaurant.rating >= 4.5 && restaurant.review_count > 500) {
                secondary.push({
                    icon: 'üë•',
                    text: 'Consistently good ‚Äî high rating with many reviews',
                    type: 'positive'
                });
            }

            // Confidence warnings
            if (restaurant.review_count && restaurant.review_count < 10) {
                secondary.push({
                    icon: '‚ùì',
                    text: `Only ${restaurant.review_count} reviews ‚Äî rating may change`,
                    type: 'negative'
                });
            } else if (restaurant.review_count && restaurant.review_count < 20) {
                secondary.push({
                    icon: '‚ùì',
                    text: `Few reviews (${restaurant.review_count}) ‚Äî limited data`,
                    type: 'neutral'
                });
            }

            // Perfect rating warning
            if (restaurant.score_perfection_penalty && restaurant.score_perfection_penalty < -0.01) {
                secondary.push({
                    icon: 'üìä',
                    text: 'Perfect 5.0 with few reviews ‚Äî take with grain of salt',
                    type: 'neutral'
                });
            }

            // === CUISINE-SPECIFIC HIGHLIGHTS ===
            const cuisine = (restaurant.cuisine || '').toLowerCase();
            const cuisineHighlights = getCuisineHighlight(cuisine, restaurant);
            if (cuisineHighlights) {
                // Add to primary if we have room, otherwise secondary
                if (primary.length < 2) {
                    primary.push(cuisineHighlights);
                } else {
                    secondary.push(cuisineHighlights);
                }
            }

            return { primary: primary.slice(0, 3), secondary: secondary.slice(0, 4) };
        }

        // Cuisine-specific highlights based on what makes each cuisine special
        function getCuisineHighlight(cuisine, restaurant) {
            const score = restaurant.brussels_score || 0;
            const rating = restaurant.rating || 0;

            // Only add highlights for restaurants with decent scores
            if (score < 0.4 || rating < 4.0) return null;

            const highlights = {
                // Belgian classics
                'belgian': { icon: 'üáßüá™', text: 'Traditional Belgian ‚Äî moules, stoofvlees, frites' },
                'flemish': { icon: 'üáßüá™', text: 'Flemish cuisine ‚Äî hearty local dishes' },

                // European cuisines
                'italian': { icon: 'üáÆüáπ', text: 'Italian ‚Äî look for fresh pasta & regional dishes' },
                'french': { icon: 'üá´üá∑', text: 'French cuisine ‚Äî classic techniques' },
                'spanish': { icon: 'üá™üá∏', text: 'Spanish ‚Äî tapas & sharing plates' },
                'greek': { icon: 'üá¨üá∑', text: 'Greek ‚Äî mezze & grilled meats' },
                'portuguese': { icon: 'üáµüáπ', text: 'Portuguese ‚Äî seafood & petiscos' },

                // Asian cuisines
                'japanese': { icon: 'üáØüáµ', text: 'Japanese ‚Äî precision & fresh ingredients' },
                'thai': { icon: 'üáπüá≠', text: 'Thai ‚Äî balance of sweet, sour, spicy' },
                'vietnamese': { icon: 'üáªüá≥', text: 'Vietnamese ‚Äî fresh herbs & pho' },
                'chinese': { icon: 'üá®üá≥', text: 'Chinese ‚Äî regional styles vary widely' },
                'korean': { icon: 'üá∞üá∑', text: 'Korean ‚Äî BBQ, bibimbap, fermented flavors' },
                'indian': { icon: 'üáÆüá≥', text: 'Indian ‚Äî spices & regional variety' },
                'lebanese': { icon: 'üá±üáß', text: 'Lebanese ‚Äî mezze & grilled meats' },
                'turkish': { icon: 'üáπüá∑', text: 'Turkish ‚Äî kebabs, pide, meze' },
                'persian': { icon: 'üáÆüá∑', text: 'Persian ‚Äî rice dishes & stews' },
                'moroccan': { icon: 'üá≤üá¶', text: 'Moroccan ‚Äî tagines & couscous' },

                // Latin American
                'mexican': { icon: 'üá≤üáΩ', text: 'Mexican ‚Äî tacos, salsas, fresh flavors' },
                'peruvian': { icon: 'üáµüá™', text: 'Peruvian ‚Äî ceviche & fusion flavors' },
                'brazilian': { icon: 'üáßüá∑', text: 'Brazilian ‚Äî churrasco & tropical flavors' },

                // African
                'ethiopian': { icon: 'üá™üáπ', text: 'Ethiopian ‚Äî injera & sharing platters' },
                'congolese': { icon: 'üá®üá©', text: 'Congolese ‚Äî poulet moamb√© & fufu' },
                'senegalese': { icon: 'üá∏üá≥', text: 'Senegalese ‚Äî thieboudienne & yassa' },

                // Specialty types
                'sushi': { icon: 'üç£', text: 'Sushi ‚Äî freshness is key' },
                'ramen': { icon: 'üçú', text: 'Ramen ‚Äî rich broths & fresh noodles' },
                'pizza': { icon: 'üçï', text: 'Pizza ‚Äî check for wood-fired oven' },
                'burger': { icon: 'üçî', text: 'Burgers ‚Äî quality beef & fresh buns' },
                'seafood': { icon: 'ü¶ê', text: 'Seafood ‚Äî freshness matters most' },
                'vegetarian': { icon: 'ü•¨', text: 'Vegetarian ‚Äî creative plant-based dishes' },
                'vegan': { icon: 'üå±', text: 'Vegan ‚Äî 100% plant-based menu' },
                'brunch': { icon: 'ü•û', text: 'Brunch ‚Äî weekend favorite' },
            };

            // Check for matches
            for (const [key, value] of Object.entries(highlights)) {
                if (cuisine.includes(key)) {
                    return { ...value, type: 'neutral' };
                }
            }

            return null;
        }

        // Generate score factors breakdown - shows what contributes to the score
        function generateScoreFactors(restaurant) {
            const factors = [];

            // Collect all significant score components
            if (restaurant.score_base_quality) {
                factors.push({
                    label: 'Base rating',
                    value: restaurant.score_base_quality,
                    max: 0.35,
                    description: `${restaurant.rating?.toFixed(1)}‚òÖ Google rating`
                });
            }

            if (restaurant.score_residual_score && Math.abs(restaurant.score_residual_score) > 0.02) {
                const isPositive = restaurant.score_residual_score > 0;
                const residualStars = restaurant.residual ? restaurant.residual.toFixed(1) : '';
                factors.push({
                    label: isPositive ? 'Outperforms peers' : 'Below peers',
                    value: restaurant.score_residual_score,
                    max: 0.20,
                    description: isPositive ? `+${residualStars}‚òÖ above expected` : `${residualStars}‚òÖ below expected`,
                    highlight: isPositive
                });
            }

            if (restaurant.score_scarcity_bonus && restaurant.score_scarcity_bonus > 0.02) {
                factors.push({
                    label: 'Scarcity bonus',
                    value: restaurant.score_scarcity_bonus,
                    max: 0.12,
                    description: 'Limited hours/days = local gem',
                    highlight: true
                });
            }

            if (restaurant.score_guide_bonus && restaurant.score_guide_bonus > 0) {
                factors.push({
                    label: 'Guide recognition',
                    value: restaurant.score_guide_bonus,
                    max: 0.08,
                    description: 'Michelin, Gault&Millau',
                    highlight: true
                });
            }

            if (restaurant.score_reddit_bonus && restaurant.score_reddit_bonus > 0) {
                factors.push({
                    label: 'Reddit approved',
                    value: restaurant.score_reddit_bonus,
                    max: 0.05,
                    description: `Mentioned ${restaurant.reddit_mentions}x on r/brussels`,
                    highlight: true
                });
            }

            if (restaurant.score_diaspora_bonus && restaurant.score_diaspora_bonus > 0.01) {
                const description = restaurant.diaspora_street
                    ? `${restaurant.diaspora_street} ‚Äî authentic community area`
                    : 'Located in authentic neighborhood';
                factors.push({
                    label: 'Diaspora bonus',
                    value: restaurant.score_diaspora_bonus,
                    max: 0.07,
                    description: description,
                    highlight: true
                });
            }

            if (restaurant.score_tourist_penalty && restaurant.score_tourist_penalty < -0.02) {
                factors.push({
                    label: 'Tourist area',
                    value: restaurant.score_tourist_penalty,
                    max: -0.08,
                    description: 'High tourist traffic zone',
                    negative: true
                });
            }

            if (restaurant.score_perfection_penalty && restaurant.score_perfection_penalty < -0.01) {
                factors.push({
                    label: 'Rating reliability',
                    value: restaurant.score_perfection_penalty,
                    max: -0.05,
                    description: 'Perfect rating with few reviews',
                    negative: true
                });
            }

            return factors;
        }

        // Generate HTML for score explanation with collapsible details
        function generateExplanationHtml(restaurant) {
            const { primary, secondary } = getScoreExplanation(restaurant);
            const scoreFactors = generateScoreFactors(restaurant);

            // If no explanations and no significant factors, show nothing
            if (primary.length === 0 && secondary.length === 0 && scoreFactors.length === 0) {
                return '';
            }

            const formatItem = (item) => {
                const styleAttr = item.style ? ` style="${item.style}"` : '';
                return `
                    <div class="explain-item explain-${item.type}"${styleAttr}>
                        <span class="explain-icon">${item.icon}</span>
                        <span class="explain-text">${item.text}</span>
                    </div>
                `;
            };

            // Format score factors as compact pills
            const formatFactor = (factor) => {
                const pct = Math.abs(factor.value * 100).toFixed(0);
                const sign = factor.value >= 0 ? '+' : '';
                const colorClass = factor.negative ? 'factor-negative' : (factor.highlight ? 'factor-highlight' : 'factor-neutral');
                return `<span class="score-factor ${colorClass}" title="${factor.description}">${factor.label} ${sign}${pct}%</span>`;
            };

            const primaryHtml = primary.map(formatItem).join('');

            // Build score factors HTML
            const factorsHtml = scoreFactors.length > 0
                ? `<div class="score-factors">
                       <div class="factors-label">Score factors:</div>
                       <div class="factors-list">${scoreFactors.map(formatFactor).join('')}</div>
                   </div>`
                : '';

            const secondaryHtml = secondary.length > 0
                ? `<div class="explain-more" id="explain-more-${restaurant.place_id || Math.random()}">
                       ${secondary.map(formatItem).join('')}
                   </div>
                   <button class="explain-toggle" onclick="this.previousElementSibling.classList.toggle('expanded'); this.textContent = this.previousElementSibling.classList.contains('expanded') ? '‚àí Less' : '+ More details';">
                       + More details
                   </button>`
                : '';

            return `
                <div class="popup-explanation">
                    <div class="explain-title">Why it's ranked <a href="/methodology" target="_blank" class="methodology-link">Learn more</a></div>
                    ${primaryHtml}
                    ${factorsHtml}
                    ${secondaryHtml}
                </div>
            `;
        }

        // Professional food map icons - 18px with refined color palette
        // Colors: Gold (must try), Emerald (recommended), Blue (above avg), Gray (average)
        function createPinIcon(color, isSelected = false, tier = 'average') {
            const size = 18;

            // Professional tier colors - optimized for map visibility
            const tierColors = {
                'must_try': '#FFD700',      // Gold - highest quality
                'recommended': '#2ECC71',   // Emerald Green - positive action
                'above_average': '#3498DB', // Bright Blue - above norm
                'average': '#95A5A6'        // Concrete Gray - minimal noise
            };

            const iconColor = tierColors[tier] || tierColors['average'];

            // Clean icons with appropriate symbols per tier (Kitchen Confidential theme)
            const tierIcons = {
                // Crown icon (Chef's Kiss) - gold with crown symbol
                'must_try': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                    <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                `,
                // Heart icon (Kitchen Approved) - green with heart
                'recommended': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                `,
                // Fork & knife (Workable) - blue with utensils
                'above_average': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                `,
                // Simple dot (Line Cook Shrug) - gray with minimal marker
                'average': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <circle cx="9" cy="9" r="2.5" fill="white"/>
                `
            };

            if (isSelected) {
                // Selected: larger (26px) with shadow and bounce effect
                const pinSize = 26;
                const scale = pinSize / size;
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="${pinSize}" height="${pinSize}" style="filter: drop-shadow(0 3px 4px rgba(0,0,0,0.35));">
                        ${tierIcons[tier] || tierIcons['average']}
                    </svg>
                `;
                return L.divIcon({
                    className: 'pin-marker pin-selected',
                    html: svg,
                    iconSize: [pinSize, pinSize],
                    iconAnchor: [pinSize / 2, pinSize / 2],
                    popupAnchor: [0, -pinSize / 2]
                });
            } else {
                // Default: 18px icon
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="${size}" height="${size}" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                        ${tierIcons[tier] || tierIcons['average']}
                    </svg>
                `;
                return L.divIcon({
                    className: 'pin-marker pin-dot',
                    html: svg,
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2],
                    popupAnchor: [0, -size / 2]
                });
            }
        }

        // Get tier from brussels_score
        // Thresholds must match backend (brussels_reranking.py)
        function getTierFromScore(score) {
            if (score >= 0.60) return 'must_try';
            if (score >= 0.50) return 'recommended';
            if (score >= 0.40) return 'above_average';
            return 'average';
        }

        let selectedMarker = null;

        // Proust Factor: Cuisine specificity - regional cuisines are more specific than generic
        // Used to show "Regional cuisine" tag in popup for specific cuisines
        const SPECIFIC_CUISINES = new Set([
            // Asian
            "Sichuan", "Szechuan", "Cantonese", "Hunan", "Taiwanese", "Shanghainese",
            "Dim Sum", "Pekinese", "Hakka",
            // Japanese
            "Ramen", "Izakaya", "Kaiseki", "Omakase", "Yakitori", "Tonkatsu", "Okonomiyaki",
            // Korean
            "Korean BBQ", "Hansik",
            // Indian
            "South Indian", "Punjabi", "Gujarati", "Bengali", "Kerala", "Chettinad", "Hyderabadi",
            // Italian
            "Neapolitan", "Sicilian", "Tuscan", "Roman", "Venetian", "Sardinian", "Piedmontese", "Emilian",
            // Spanish
            "Basque", "Catalan", "Galician", "Andalusian",
            // French
            "Lyonnaise", "Proven√ßal", "Alsatian", "Breton", "Burgundian", "Savoyard",
            // Mexican
            "Oaxacan", "Yucatecan", "Jalisciense",
            // Middle Eastern
            "Levantine", "Palestinian", "Yemeni", "Kurdish",
            // African
            "Ethiopian", "Eritrean", "Senegalese", "Ivorian", "Cameroonian", "Ghanaian", "Nigerian"
        ]);

        function isSpecificCuisine(cuisine) {
            return cuisine && SPECIFIC_CUISINES.has(cuisine);
        }

        // Generate diaspora context HTML (informational - cultural geography)
        function generateDiasporaHtml(restaurant) {
            const context = restaurant.diaspora_context;
            if (!context || (!context.is_in_diaspora_area && !context.diaspora_streets?.length && !context.community_description)) {
                return '';
            }

            let html = '<div class="popup-diaspora">';
            html += '<div class="popup-diaspora-header">üåç Cultural Context</div>';

            if (context.is_in_diaspora_area) {
                html += `<div>This ${restaurant.cuisine} restaurant is in a traditional ${restaurant.cuisine} neighborhood</div>`;
            }

            if (context.diaspora_streets && context.diaspora_streets.length > 0) {
                html += `<div class="popup-diaspora-streets">Nearby ${restaurant.cuisine} food streets: ${context.diaspora_streets.join(', ')}</div>`;
            }

            if (context.community_description) {
                html += `<div class="popup-diaspora-desc">${context.community_description}</div>`;
            }

            html += '</div>';
            return html;
        }

        // Generate popup HTML lazily (only when clicked)
        function generatePopupContent(restaurant) {
            const commune = restaurant.commune || 'Unknown';
            const neighborhood = restaurant.neighborhood ? ` (${restaurant.neighborhood})` : '';

            // Generate improved explanation HTML with collapsible details
            const explanationHtml = generateExplanationHtml(restaurant);

            // Generate opening hours HTML
            const hoursHtml = generateHoursHtml(restaurant.opening_hours);

            // Generate guide badges - show ALL recognitions (not mutually exclusive)
            let guideBadges = '';
            if (restaurant.michelin_stars >= 2) {
                guideBadges += `<span class="guide-badge michelin-2">${'‚≠ê'.repeat(restaurant.michelin_stars)} Michelin</span>`;
            } else if (restaurant.michelin_stars === 1) {
                guideBadges += `<span class="guide-badge michelin">‚≠ê Michelin</span>`;
            } else if (restaurant.bib_gourmand) {
                guideBadges += `<span class="guide-badge bib-gourmand">Bib Gourmand</span>`;
            }
            // Gault & Millau is independent - can be shown alongside Michelin/Bib
            if (restaurant.gault_millau) {
                guideBadges += `<span class="guide-badge gault-millau">Gault&Millau</span>`;
            }
            // Reddit community endorsement
            if (restaurant.reddit_mentions && restaurant.reddit_mentions >= 2) {
                guideBadges += `<span class="guide-badge reddit">r/brussels</span>`;
            }
            const badgesHtml = guideBadges ? `<div class="guide-badges">${guideBadges}</div>` : '';

            const score = restaurant.brussels_score || 0;

            // Generate diaspora cultural context (informational)
            const diasporaHtml = generateDiasporaHtml(restaurant);

            // Check if this is a specific regional cuisine (Proust Factor)
            const isRegional = isSpecificCuisine(restaurant.cuisine);
            const cuisineDisplay = restaurant.cuisine || 'Restaurant';
            const regionalTag = isRegional ? ' <span style="background:#f0fdf4;color:#166534;padding:1px 6px;border-radius:4px;font-size:10px;margin-left:4px;">Regional</span>' : '';

            return `
                <div class="popup-name">${escapeHtml(restaurant.name)}</div>
                ${badgesHtml}
                <div class="popup-commune">${escapeHtml(commune)}${escapeHtml(neighborhood)}</div>
                <div class="popup-cuisine">${escapeHtml(cuisineDisplay)}${regionalTag}</div>
                <div class="popup-stats">
                    <span>‚òÖ ${restaurant.rating?.toFixed(1) || 'N/A'}</span>
                    <span>${restaurant.review_count || 0} reviews</span>
                    ${score ? `<span>Score: ${score.toFixed(2)}</span>` : ''}
                </div>
                ${hoursHtml}
                ${diasporaHtml}
                ${explanationHtml}
                ${restaurant.google_maps_url ?
                    `<a href="${restaurant.google_maps_url}" target="_blank" class="popup-link">View on Google Maps ‚Üí</a>` : ''
                }
            `;
        }

        function createMarker(restaurant) {
            const color = getMarkerColor(restaurant);
            const tier = getTierFromScore(restaurant.brussels_score || 0);

            // All markers start as small dots with tier-specific icon
            const marker = L.marker([restaurant.lat, restaurant.lng], {
                icon: createPinIcon(color, false, tier)
            });

            // Store color, tier and restaurant data for selection
            marker.restaurantColor = color;
            marker.restaurantTier = tier;
            marker.restaurantData = restaurant;

            // Lazy popup binding - only generate HTML when first clicked
            let popupBound = false;

            // On click, expand this marker to full pin
            marker.on('click', function() {
                const self = this;

                // Bind popup lazily on first click
                if (!popupBound) {
                    self.bindPopup(generatePopupContent(restaurant));
                    popupBound = true;
                }

                // Reset previous selected marker
                if (selectedMarker && selectedMarker !== self) {
                    selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                }
                // Expand this marker
                self.setIcon(createPinIcon(self.restaurantColor, true, self.restaurantTier));
                selectedMarker = self;

                // Open popup with slight delay on mobile to ensure binding is complete
                setTimeout(function() {
                    self.openPopup();
                }, isMobile ? 50 : 0);
            });

            return marker;
        }

        // Click on map to deselect marker
        map.on('click', function(e) {
            if (selectedMarker && !e.originalEvent.target.closest('.pin-marker')) {
                selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                selectedMarker = null;
            }
        });

        // Helper function to check if restaurant is open on a specific day
        function isOpenOnDay(openingHours, day) {
            if (!openingHours || openingHours.length === 0) return true; // Include unknowns

            const dayHours = openingHours.find(h => h && h.startsWith(day));
            if (!dayHours) return false;

            if (dayHours.toLowerCase().includes('closed')) return false;

            return true;
        }

        // Helper function to check if restaurant is open at a specific time
        function isOpenAtTime(openingHours, day, hour) {
            if (!openingHours || openingHours.length === 0) return true; // Include unknowns

            const dayHours = openingHours.find(h => h && h.startsWith(day));
            if (!dayHours) return false;

            if (dayHours.toLowerCase().includes('closed')) return false;

            // Parse hours like "Monday: 12:00 ‚Äì 2:30 PM, 6:00 ‚Äì 10:00 PM"
            const hoursPart = dayHours.split(': ')[1];
            if (!hoursPart) return true;

            // Split by comma for multiple time ranges
            const ranges = hoursPart.split(',').map(r => r.trim());

            for (const range of ranges) {
                // Parse time range - handle various formats
                // Google format: "6:30 ‚Äì 9:30 PM" (PM applies to BOTH times)
                const match = range.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?\s*[‚Äì-]\s*(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
                if (!match) continue;

                let startHour = parseInt(match[1]);
                const startAMPM = match[3]?.toUpperCase();
                let endHour = parseInt(match[4]);
                const endAMPM = match[6]?.toUpperCase();

                // If only end has AM/PM, it applies to both (Google format)
                // e.g., "6:30 ‚Äì 9:30 PM" means 6:30 PM ‚Äì 9:30 PM
                const effectiveStartAMPM = startAMPM || endAMPM;
                const effectiveEndAMPM = endAMPM || startAMPM;

                // Convert to 24h format
                if (effectiveStartAMPM === 'PM' && startHour !== 12) startHour += 12;
                if (effectiveStartAMPM === 'AM' && startHour === 12) startHour = 0;
                if (effectiveEndAMPM === 'PM' && endHour !== 12) endHour += 12;
                if (effectiveEndAMPM === 'AM' && endHour === 12) endHour = 0;

                // Handle overnight hours (e.g., 6 PM - 2 AM)
                if (endHour < startHour) endHour += 24;

                if (hour >= startHour && hour < endHour) return true;
            }

            return false;
        }

        async function loadRestaurants() {
            const params = new URLSearchParams();

            const search = document.getElementById('search').value;
            const commune = document.getElementById('commune-filter').value;
            const cuisine = document.getElementById('cuisine-filter').value;
            const minRating = document.getElementById('rating-filter').value;
            const priceLevel = document.getElementById('price-filter').value;
            const sortBy = document.getElementById('sort-filter').value;
            const venueType = document.getElementById('venue-filter').value;
            const guideFilter = document.getElementById('guide-filter').value;
            const dayFilter = document.getElementById('day-filter').value;
            const timeFilter = document.getElementById('time-filter').value;

            if (search) params.append('search', search);
            if (commune !== 'all') params.append('commune', commune);
            if (cuisine !== 'all') params.append('cuisine', cuisine);
            if (minRating) params.append('min_rating', minRating);
            if (priceLevel) params.append('price_level', priceLevel);
            if (venueType !== 'all') params.append('venue_type', venueType);
            if (guideFilter) params.append('guide', guideFilter);
            if (dayFilter) params.append('open_day', dayFilter);
            params.append('sort_by', sortBy);

            if (currentFilter === 'brussels_gems') params.append('brussels_gems', 'true');
            if (currentFilter === 'diaspora') params.append('diaspora_only', 'true');

            try {
                const response = await fetch(`/api/restaurants?${params}`);
                let data = await response.json();

                // Client-side day/time filtering (more accurate than server-side)
                if (dayFilter) {
                    if (timeFilter) {
                        // Filter by day AND specific time
                        data = data.filter(r => isOpenAtTime(r.opening_hours, dayFilter, parseInt(timeFilter)));
                    } else {
                        // Filter by day only (any time that day)
                        data = data.filter(r => isOpenOnDay(r.opening_hours, dayFilter));
                    }
                }

                restaurants = data;

                updateMarkers();
                updateList();
                updateStats();
            } catch (error) {
                console.error('Error loading restaurants:', error);
                document.getElementById('restaurant-list').innerHTML =
                    '<div class="loading">Error loading data</div>';
            }
        }

        function updateMarkers() {
            markersLayer.clearLayers();

            // Sort by score ascending so higher-scored restaurants are rendered last (on top)
            const sorted = [...restaurants].sort((a, b) =>
                (a.brussels_score || 0) - (b.brussels_score || 0)
            );

            // On mobile, batch marker creation for better performance
            if (isMobile && sorted.length > 50) {
                // Add markers in smaller chunks to keep UI responsive
                const chunkSize = 25;
                let index = 0;

                function addChunk() {
                    const chunk = sorted.slice(index, index + chunkSize);
                    chunk.forEach(restaurant => {
                        if (restaurant.lat && restaurant.lng) {
                            const marker = createMarker(restaurant);
                            markersLayer.addLayer(marker);
                        }
                    });
                    index += chunkSize;
                    if (index < sorted.length) {
                        requestAnimationFrame(addChunk);
                    }
                }
                addChunk();
            } else {
                sorted.forEach(restaurant => {
                    if (restaurant.lat && restaurant.lng) {
                        const marker = createMarker(restaurant);
                        markersLayer.addLayer(marker);
                    }
                });
            }
        }

        function updateList() {
            const listEl = document.getElementById('restaurant-list');
            const countEl = document.getElementById('results-count');

            countEl.textContent = `${restaurants.length} restaurants`;

            if (restaurants.length === 0) {
                listEl.innerHTML = '<div class="loading">No restaurants found</div>';
                return;
            }

            // Show fewer items on mobile for faster rendering
            const listLimit = isMobile ? 30 : 50;
            listEl.innerHTML = restaurants.slice(0, listLimit).map(r => {
                const score = r.brussels_score?.toFixed(2) || '';
                const isUnderexplored = r.commune_tier === 'underexplored';
                const commune = r.commune || '';
                const openStatus = getOpenStatus(r.opening_hours);

                // Build hours display for card
                let hoursHtml = '';
                if (openStatus.status !== 'unknown') {
                    hoursHtml = `
                        <div class="restaurant-hours">
                            <div class="restaurant-hours-status">
                                <span class="hours-status-dot ${openStatus.status}"></span>
                                <span>${openStatus.status === 'closed' ? 'Closed today' : openStatus.text}</span>
                            </div>
                        </div>
                    `;
                }

                // Guide badges for cards - show ALL recognitions (not mutually exclusive)
                let cardGuideBadges = '';
                if (r.michelin_stars >= 2) {
                    cardGuideBadges += `<span class="guide-badge michelin-2">${'‚≠ê'.repeat(r.michelin_stars)} Michelin</span>`;
                } else if (r.michelin_stars === 1) {
                    cardGuideBadges += `<span class="guide-badge michelin">‚≠ê Michelin</span>`;
                } else if (r.bib_gourmand) {
                    cardGuideBadges += `<span class="guide-badge bib-gourmand">Bib Gourmand</span>`;
                }
                // Gault & Millau is independent - can be shown alongside Michelin/Bib
                if (r.gault_millau) {
                    cardGuideBadges += `<span class="guide-badge gault-millau">Gault&Millau</span>`;
                }
                // Reddit community endorsement
                if (r.reddit_mentions && r.reddit_mentions >= 2) {
                    cardGuideBadges += `<span class="guide-badge reddit">r/brussels</span>`;
                }

                const isMobileView = window.innerWidth <= 768;
                return `
                    <div class="restaurant-card" onclick="${isMobileView ? 'flyToMobile' : 'flyTo'}(${r.lat}, ${r.lng})">
                        <div class="restaurant-header">
                            <div class="restaurant-name">${escapeHtml(r.name)}</div>
                            <div class="restaurant-badges">
                                ${cardGuideBadges}
                                ${isUnderexplored ? '<span class="badge badge-underexplored">Hidden</span>' : ''}
                            </div>
                        </div>
                        <div class="restaurant-location">${escapeHtml(commune)}</div>
                        <div class="restaurant-cuisine">${escapeHtml(r.cuisine) || 'Restaurant'}</div>
                        <div class="restaurant-meta">
                            <span class="restaurant-rating">
                                <span class="star">‚òÖ</span>
                                ${r.rating?.toFixed(1) || 'N/A'}
                            </span>
                            <span>${r.review_count || 0} reviews</span>
                            <span>${'‚Ç¨'.repeat(r.price_numeric || 2)}</span>
                        </div>
                        ${hoursHtml}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('total-restaurants').textContent = restaurants.length;
            document.getElementById('total-gems').textContent =
                restaurants.filter(r => (r.brussels_score || 0) >= 0.50).length;

            const cuisines = new Set(restaurants.map(r => r.cuisine).filter(Boolean));
            document.getElementById('total-cuisines').textContent = cuisines.size;
        }

        function flyTo(lat, lng) {
            map.flyTo([lat, lng], 16);
            // Find and open the marker popup at this location
            setTimeout(() => {
                markersLayer.eachLayer(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                        marker.openPopup();
                        // Also select the marker visually
                        if (selectedMarker && selectedMarker !== marker) {
                            selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                        }
                        marker.setIcon(createPinIcon(marker.restaurantColor, true, marker.restaurantTier));
                        selectedMarker = marker;
                    }
                });
            }, 500);
        }

        function flyToMobile(lat, lng) {
            // Switch to map tab and fly to location
            switchTab('map');
            setTimeout(() => {
                map.invalidateSize();
                setTimeout(() => {
                    map.flyTo([lat, lng], 16);
                    // Find and open the marker popup at this location
                    setTimeout(() => {
                        markersLayer.eachLayer(marker => {
                            const markerLatLng = marker.getLatLng();
                            if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                                marker.openPopup();
                                // Also select the marker visually
                                if (selectedMarker && selectedMarker !== marker) {
                                    selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                                }
                                marker.setIcon(createPinIcon(marker.restaurantColor, true, marker.restaurantTier));
                                selectedMarker = marker;
                            }
                        });
                    }, 500);
                }, 100);
            }, 100);
        }

        async function loadHexagons() {
            try {
                const response = await fetch('/api/hexagons');
                const geojson = await response.json();

                hexagonsLayer.clearLayers();

                L.geoJSON(geojson, {
                    style: feature => ({
                        fillColor: getHexColor(feature.properties.cluster_label),
                        color: '#000',
                        weight: 1,
                        fillOpacity: 0.5
                    }),
                    onEachFeature: (feature, layer) => {
                        const p = feature.properties;
                        layer.bindPopup(`
                            <div class="popup-name">${p.cluster_label} Area</div>
                            <div class="popup-stats">
                                <span>Restaurants: ${p.restaurant_count}</span>
                                <span>Avg: ${p.mean_rating}‚òÖ</span>
                            </div>
                        `);
                    }
                }).addTo(hexagonsLayer);
            } catch (error) {
                console.error('Error loading hexagons:', error);
            }
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', debounce(loadRestaurants, 300));
        document.getElementById('commune-filter').addEventListener('change', loadRestaurants);
        document.getElementById('cuisine-filter').addEventListener('change', loadRestaurants);
        document.getElementById('venue-filter').addEventListener('change', loadRestaurants);
        document.getElementById('rating-filter').addEventListener('change', loadRestaurants);
        document.getElementById('price-filter').addEventListener('change', loadRestaurants);
        document.getElementById('sort-filter').addEventListener('change', loadRestaurants);
        document.getElementById('guide-filter').addEventListener('change', loadRestaurants);
        document.getElementById('day-filter').addEventListener('change', loadRestaurants);
        document.getElementById('time-filter').addEventListener('change', loadRestaurants);

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`show-${filter === 'all' ? 'all' : filter.replace('_', '-')}`).classList.add('active');
            loadRestaurants();
        }

        document.getElementById('show-all').addEventListener('click', () => setFilter('all'));
        document.getElementById('show-brussels-gems').addEventListener('click', () => setFilter('brussels_gems'));

        // Add touch feedback for mobile
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('touchstart', () => btn.style.opacity = '0.7');
            btn.addEventListener('touchend', () => btn.style.opacity = '1');
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        loadRestaurants();

        // Mobile tab navigation
        const container = document.querySelector('.container');
        const mobileTabs = document.querySelectorAll('.mobile-tab');

        function switchTab(tabName) {
            // Update container class
            container.classList.remove('tab-map', 'tab-search', 'tab-results');
            container.classList.add(`tab-${tabName}`);

            // Update active tab
            mobileTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Resize map when switching to map tab
            if (tabName === 'map') {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        mobileTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        // Start with map tab on mobile
        if (window.innerWidth <= 768) {
            container.classList.add('tab-map');
            setTimeout(() => map.invalidateSize(), 100);
        }

        // Info popup functionality
        const infoBtn = document.getElementById('info-btn');
        const infoOverlay = document.getElementById('info-overlay');
        const infoClose = document.getElementById('info-close');

        infoBtn.addEventListener('click', () => {
            infoOverlay.classList.add('active');
        });

        infoClose.addEventListener('click', () => {
            infoOverlay.classList.remove('active');
            // Remember that user has seen the info popup
            localStorage.setItem('brussels_food_map_info_seen', 'true');
        });

        infoOverlay.addEventListener('click', (e) => {
            if (e.target === infoOverlay) {
                infoOverlay.classList.remove('active');
                localStorage.setItem('brussels_food_map_info_seen', 'true');
            }
        });

        // Show info popup on first visit
        if (!localStorage.getItem('brussels_food_map_info_seen')) {
            setTimeout(() => {
                infoOverlay.classList.add('active');
            }, 500); // Small delay to let the map load first
        }
    </script>
</body>
</html>
