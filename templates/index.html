<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brussels Food Map - Hidden Gems</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            /* Apple Maps style - clean, minimal */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-elevated: #ffffff;
            --bg-hover: #e8e8ed;

            /* Border colors */
            --border-subtle: #d2d2d7;
            --border-default: #c6c6c8;
            --border-focus: #007aff;

            /* Text colors */
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-muted: #aeaeb2;

            /* Accent colors - Apple style */
            --accent-green: #34c759;
            --accent-green-light: #30d158;
            --accent-orange: #ff9500;
            --accent-blue: #007aff;
            --accent-purple: #af52de;
            --accent-red: #ff3b30;
            --accent-yellow: #ffcc00;

            /* Shadows - subtle Apple style */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.12);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, #FDF6E3 0%, #F8F1E4 100%);
            border-right: 1px solid #D4C4B0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 50%, #EDE0D4 100%);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            width: 100px;
            height: 100px;
            border-radius: 14px;
            object-fit: cover;
            box-shadow: var(--shadow-md);
        }

        .header-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #8B4513 0%, #D4A574 50%, #8B4513 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.01em;
        }

        .header-text p {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #EDE0D4 0%, #E6D5C3 100%);
            border-bottom: 1px solid #D4C4B0;
        }

        .stat {
            text-align: center;
            padding: 6px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #8B4513;
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 2px;
        }

        .filters {
            padding: 12px 20px;
            border-bottom: 1px solid #D4C4B0;
            background: #FDF6E3;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            flex: 1;
        }

        .filter-group.full-width {
            flex: none;
            width: 100%;
        }

        .filter-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px;
            background: #FFFDF9;
            border: 1px solid #D4C4B0;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all var(--transition-normal);
        }

        .search-input::placeholder {
            color: #A89B8C;
        }

        .search-input:focus {
            outline: none;
            background: var(--bg-primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
        }

        select {
            width: 100%;
            padding: 10px 14px;
            background: #FFFDF9;
            border: 1px solid #D4C4B0;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
            transition: all var(--transition-normal);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%238B7355' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        select:focus {
            outline: none;
            background: #FFFDF9;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2);
        }

        .toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            min-width: 70px;
            padding: 8px 12px;
            background: #FFFDF9;
            border: 1px solid #D4C4B0;
            border-radius: 20px;
            color: #5D4E37;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .toggle-btn:hover {
            background: #EDE0D4;
        }

        .toggle-btn.active {
            background: #8B4513;
            color: #FFFDF9;
            font-weight: 600;
            border-color: #8B4513;
        }

        .results {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 12px 16px;
            background: linear-gradient(180deg, #EDE0D4 0%, #E6D5C3 100%);
            min-height: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .results-count {
            font-size: 12px;
            font-weight: 500;
            color: #5D4E37;
        }

        .restaurant-card {
            background: #FFFDF9;
            border: 1px solid #D4C4B0;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .restaurant-card:hover {
            transform: scale(1.01);
            box-shadow: var(--shadow-md);
        }

        .restaurant-card:active {
            transform: scale(0.99);
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .restaurant-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.3;
        }

        .restaurant-badges {
            display: flex;
            gap: 6px;
            margin-left: 8px;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-score {
            background: linear-gradient(135deg, var(--accent-green-light) 0%, var(--accent-green) 100%);
            color: #000;
        }

        .badge-underexplored {
            background: var(--accent-purple);
            color: #fff;
        }

        .restaurant-location {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .restaurant-cuisine {
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .restaurant-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #fbbc04;
        }

        .restaurant-hours {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
            font-size: 12px;
            color: var(--text-muted);
        }

        .restaurant-hours-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hours-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .hours-status-dot.open {
            background: var(--accent-green);
        }

        .hours-status-dot.closed {
            background: var(--accent-red);
        }

        .hours-status-dot.unknown {
            background: var(--text-muted);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-legend {
            position: absolute;
            bottom: 24px;
            right: 16px;
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #D4C4B0;
            border-radius: 14px;
            padding: 14px 16px;
            z-index: 1000;
            font-size: 12px;
            box-shadow: var(--shadow-md);
        }

        .legend-title {
            font-size: 13px;
            font-weight: 600;
            color: #5D4E37;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            color: #5D4E37;
            font-size: 12px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        /* Info button */
        .info-btn {
            position: absolute;
            top: 70px;
            right: 16px;
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #D4C4B0;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            font-weight: 600;
            color: #8B4513;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-btn:hover {
            background: #8B4513;
            color: #FFFDF9;
        }

        /* Info popup overlay */
        .info-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .info-overlay.active {
            display: flex;
        }

        .info-popup {
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 100%);
            border: 1px solid #D4C4B0;
            border-radius: 16px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .info-popup h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #5D4E37;
        }

        .info-popup .info-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .info-popup .info-icon {
            font-size: 16px;
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .info-popup .info-text {
            color: #6B5D4D;
        }

        .info-popup .info-text strong {
            color: #5D4E37;
        }

        .info-popup hr {
            border: none;
            border-top: 1px solid #D4C4B0;
            margin: 16px 0;
        }

        .info-popup .info-icons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            font-size: 13px;
            color: #5D4E37;
        }

        .info-popup .info-icons span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-popup .info-icons .icon-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .info-close {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            background: #8B4513;
            color: #FFFDF9;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .info-close:hover {
            background: #6B3410;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .leaflet-popup-content {
            color: var(--text-primary);
            margin: 14px;
            font-size: 13px;
        }

        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }

        .popup-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .popup-commune {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .popup-cuisine {
            color: var(--accent-green);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .popup-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 6px;
            color: var(--accent-green);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .popup-link:hover {
            background: var(--bg-hover);
            text-decoration: none;
        }

        .popup-hours {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .popup-hours-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .popup-hours-header:hover {
            color: var(--text-primary);
        }

        .popup-hours-toggle {
            font-size: 10px;
            transition: transform var(--transition-fast);
        }

        .popup-hours-toggle.expanded {
            transform: rotate(90deg);
        }

        .popup-hours-list {
            display: none;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .popup-hours-list.show {
            display: block;
        }

        .popup-hours-list div {
            padding: 2px 0;
        }

        .popup-hours-list .today {
            color: var(--accent-green);
            font-weight: 500;
        }

        .popup-hours-list .closed {
            color: var(--accent-red);
        }

        /* Guide recognition badges */
        .guide-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .guide-badge.michelin {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
        }

        .guide-badge.michelin-2 {
            background: linear-gradient(135deg, #ffd700 0%, #c41e3a 100%);
            color: white;
        }

        .guide-badge.bib-gourmand {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            font-size: 9px;
        }

        .guide-badge.gault-millau {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffd700;
            border: 1px solid #ffd700;
        }

        .guide-badges {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .popup-explanation {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
            font-size: 12px;
            line-height: 1.7;
        }

        .explain-title {
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .explain-positive {
            color: var(--accent-green-light);
        }

        .explain-negative {
            color: var(--accent-red);
        }

        .explain-neutral {
            color: var(--accent-yellow);
        }

        .commune-label {
            background: transparent !important;
            border: none !important;
            pointer-events: none;
        }

        .pin-marker {
            background: transparent !important;
            border: none !important;
        }

        .pin-marker svg {
            transition: transform 0.25s ease-out;
        }

        .pin-dot:hover svg {
            transform: scale(1.3);
        }

        .pin-selected svg {
            transform-origin: bottom center;
        }

        .commune-label div {
            text-align: center;
            letter-spacing: 0.5px;
        }

        .layer-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #D4C4B0;
            border-radius: 22px;
            padding: 4px;
            z-index: 1000;
            display: flex;
            gap: 2px;
            box-shadow: var(--shadow-md);
        }

        .layer-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 18px;
            color: #6B5D4D;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .layer-btn:hover {
            color: #5D4E37;
        }

        .layer-btn.active {
            background: #8B4513;
            color: #FFFDF9;
            font-weight: 600;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #666;
            font-size: 13px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
            }

            .map-container {
                height: 50vh;
                min-height: 300px;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                padding: 12px 16px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 9px;
            }

            .filters {
                padding: 12px 16px;
            }

            .filter-row {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 12px;
            }

            .results {
                padding: 12px 16px;
                touch-action: pan-y;
            }

            .restaurant-card {
                padding: 12px;
            }

            .toggle-btn {
                min-width: 70px;
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .toggle-group {
                flex-wrap: wrap;
            }

            .toggle-btn {
                flex: 1 1 45%;
            }
        }

        /* Disable heavy transitions on mobile for snappier UX */
        @media (max-width: 768px) {
            .restaurant-card,
            .toggle-btn,
            select,
            .search-input {
                transition: none !important;
            }

            .restaurant-card:hover {
                transform: none;
            }
        }

        /* Mobile tab navigation */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1100;
            background: linear-gradient(135deg, #FDF6E3 0%, #F5E6D3 100%);
            border-top: 1px solid #D4C4B0;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .mobile-tabs-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: none;
            border: none;
            color: #8B7355;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }

        .mobile-tab.active {
            color: #8B4513;
        }

        .mobile-tab-icon {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .mobile-tabs {
                display: block;
            }

            /* Hide old toggle button */
            .mobile-toggle {
                display: none !important;
            }

            /* Tab: Map */
            .container.tab-map .sidebar {
                display: none;
            }

            .container.tab-map .map-container {
                height: calc(100vh - 70px);
                height: calc(100dvh - 70px);
            }

            .container.tab-map .map-legend {
                bottom: 80px;
            }

            /* Tab: Search */
            .container.tab-search .map-container {
                display: none;
            }

            .container.tab-search .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 70px;
                width: 100%;
                height: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                background: linear-gradient(180deg, #FDF6E3 0%, #F8F1E4 100%);
            }

            .container.tab-search .header {
                padding: 12px 16px;
            }

            .container.tab-search .header-logo {
                width: 50px;
                height: 50px;
            }

            .container.tab-search .stats {
                display: none;
            }

            .container.tab-search .filters {
                padding: 12px 16px;
                padding-bottom: 40px;
            }

            .container.tab-search .filters .filter-row {
                flex-direction: column;
                gap: 12px;
            }

            .container.tab-search .results {
                display: none;
            }

            /* Tab: Results */
            .container.tab-results .map-container {
                display: none;
            }

            .container.tab-results .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 70px;
                width: 100%;
                height: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                background: linear-gradient(180deg, #EDE0D4 0%, #E6D5C3 100%);
            }

            .container.tab-results .header {
                display: none;
            }

            .container.tab-results .stats {
                display: none;
            }

            .container.tab-results .filters {
                display: none;
            }

            .container.tab-results .results {
                padding: 12px 16px;
                padding-bottom: 40px;
                overflow: visible;
                max-height: none;
            }

            /* Hide legend/info in non-map tabs */
            .container.tab-search .map-legend,
            .container.tab-search .info-btn,
            .container.tab-results .map-legend,
            .container.tab-results .info-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <div class="header-content">
                    <img src="/static/logo.jpg" alt="Brussels Food Map" class="header-logo">
                    <div class="header-text">
                        <h1>Brussels Food Map</h1>
                        <p>Discover hidden gems</p>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="total-restaurants">-</div>
                    <div class="stat-label">Restaurants</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-communes">19</div>
                    <div class="stat-label">Communes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-gems">-</div>
                    <div class="stat-label">Top Picks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-cuisines">-</div>
                    <div class="stat-label">Cuisines</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group full-width">
                    <label class="filter-label">Search</label>
                    <input type="text" class="search-input" id="search" placeholder="Restaurant name...">
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Commune</label>
                        <select id="commune-filter">
                            <option value="all">All Communes</option>
                            {% for commune in communes %}
                            <option value="{{ commune }}">{{ commune }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Cuisine</label>
                        <select id="cuisine-filter">
                            <option value="all">All Cuisines</option>
                            {% for cuisine in cuisines %}
                            <option value="{{ cuisine }}">{{ cuisine }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Venue Type</label>
                        <select id="venue-filter">
                            <option value="all">All Venues</option>
                            <option value="Restaurant" selected>Restaurants Only</option>
                            <option value="Sandwich_shop">Sandwich Shops</option>
                            <option value="Fast_food">Fast Food</option>
                            <option value="Cafe">Cafes</option>
                            <option value="Bar">Bars</option>
                            <option value="Bakery">Bakeries</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Rating</label>
                        <select id="rating-filter">
                            <option value="">Any</option>
                            <option value="3.5">3.5+</option>
                            <option value="4.0">4.0+</option>
                            <option value="4.5">4.5+</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Price</label>
                        <select id="price-filter">
                            <option value="">Any</option>
                            <option value="1">‚Ç¨ (Budget)</option>
                            <option value="2">‚Ç¨‚Ç¨ (Moderate)</option>
                            <option value="3">‚Ç¨‚Ç¨‚Ç¨ (Expensive)</option>
                            <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Fine Dining)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sort-filter">
                            <option value="brussels_score">Brussels Score</option>
                            <option value="rating">Rating</option>
                            <option value="residual">Undervalued</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Open On</label>
                        <select id="day-filter">
                            <option value="">Any Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Open At</label>
                        <select id="time-filter">
                            <option value="">Any Time</option>
                            <option value="12">12:00 (Lunch)</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00 (Dinner)</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00 (Late)</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Recognition</label>
                        <select id="guide-filter">
                            <option value="">Any</option>
                            <option value="michelin">Michelin Stars</option>
                            <option value="bib">Bib Gourmand</option>
                            <option value="gaultmillau">Gault & Millau</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group full-width">
                    <label class="filter-label">Show</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" id="show-all">All</button>
                        <button class="toggle-btn" id="show-brussels-gems">Brussels Gems</button>
                        <button class="toggle-btn" id="show-underrated">Underrated</button>
                    </div>
                </div>
            </div>

            <div class="results">
                <div class="results-header">
                    <span class="results-count" id="results-count">Loading...</span>
                </div>
                <div id="restaurant-list">
                    <div class="loading">Loading restaurants...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="layer-toggle">
                <button class="layer-btn active" id="layer-markers">Restaurants</button>
                <button class="layer-btn" id="layer-hexagons">Neighborhoods</button>
            </div>
            <div id="map"></div>
        </div>

        <button class="mobile-toggle" id="mobile-toggle" style="display:none;">Show Map</button>

        <!-- Mobile Tab Navigation -->
        <div class="mobile-tabs">
            <div class="mobile-tabs-inner">
                <button class="mobile-tab active" data-tab="map">
                    <span class="mobile-tab-icon">üó∫Ô∏è</span>
                    <span>Map</span>
                </button>
                <button class="mobile-tab" data-tab="search">
                    <span class="mobile-tab-icon">üîç</span>
                    <span>Search</span>
                </button>
                <button class="mobile-tab" data-tab="results">
                    <span class="mobile-tab-icon">üìã</span>
                    <span>Results</span>
                </button>
            </div>
        </div>
        <button class="info-btn" id="info-btn">i</button>
        <div class="map-legend" id="legend-markers">
                <div class="legend-title">Brussels Food Map</div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#FFD700"/>
                        <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                        <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                    </svg>
                    <span>Must try</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#2ECC71"/>
                        <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                    </svg>
                    <span>Recommended</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#3498DB"/>
                        <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                    </svg>
                    <span>Above average</span>
                </div>
                <div class="legend-item">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#95A5A6"/>
                        <circle cx="9" cy="9" r="2.5" fill="white"/>
                    </svg>
                    <span>Average</span>
                </div>
            </div>
            <div class="map-legend" id="legend-hexagons" style="display: none;">
                <div class="legend-title">Neighborhood Type</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ade80;"></div>
                    <span>Elite</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #60a5fa;"></div>
                    <span>Strong</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fbbf24;"></div>
                    <span>Everyday</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #a78bfa;"></div>
                    <span>Emerging</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Popup Overlay -->
    <div class="info-overlay" id="info-overlay">
        <div class="info-popup">
            <h3>How we find hidden gems</h3>
            <div class="info-item">
                <span class="info-icon">‚≠ê</span>
                <span class="info-text"><strong>Beats expectations</strong> ‚Äî ML model detects places rated higher than predicted</span>
            </div>
            <div class="info-item">
                <span class="info-icon">üîí</span>
                <span class="info-text"><strong>Scarce access</strong> ‚Äî Limited hours or days? Locals know it's worth the effort</span>
            </div>
            <div class="info-item">
                <span class="info-icon">üë•</span>
                <span class="info-text"><strong>Right crowd</strong> ‚Äî 50-500 reviews = known locally, not tourist-famous</span>
            </div>
            <div class="info-item">
                <span class="info-icon">üè™</span>
                <span class="info-text"><strong>Independent</strong> ‚Äî Non-chains get priority</span>
            </div>
            <div class="info-item">
                <span class="info-icon">üìç</span>
                <span class="info-text"><strong>Off the beaten path</strong> ‚Äî Penalty near Grand Place & tourist traps</span>
            </div>
            <div class="info-item">
                <span class="info-icon">üèÜ</span>
                <span class="info-text"><strong>Guide-approved</strong> ‚Äî Michelin, Bib Gourmand, Gault&Millau bonus</span>
            </div>
            <hr>
            <div class="info-icons">
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#FFD700"/>
                        <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                        <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                    </svg>
                    Must try
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#2ECC71"/>
                        <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                    </svg>
                    Recommended
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#3498DB"/>
                        <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                    </svg>
                    Above average
                </span>
                <span>
                    <svg width="16" height="16" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="8.5" fill="#95A5A6"/>
                        <circle cx="9" cy="9" r="2.5" fill="white"/>
                    </svg>
                    Average
                </span>
            </div>
            <button class="info-close" id="info-close">Got it</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Brussels - optimized for mobile
        const isMobile = window.innerWidth <= 768;
        const map = L.map('map', {
            zoomControl: false,
            // Disable animations on mobile for snappier feel
            zoomAnimation: !isMobile,
            fadeAnimation: !isMobile,
            markerZoomAnimation: !isMobile,
            // Faster touch response
            tap: true,
            tapTolerance: 15,
            touchZoom: 'center',
            bounceAtZoomLimits: false
        }).setView([50.8503, 4.3517], 13);

        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        // Use CartoDB Voyager for clean Google Maps-like appearance
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19,
            // Better tile loading on mobile
            updateWhenIdle: isMobile,
            updateWhenZooming: false,
            keepBuffer: isMobile ? 2 : 4
        }).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);
        let hexagonsLayer = L.layerGroup();
        let communeLabelsLayer = L.layerGroup().addTo(map);

        // Brussels commune centers for labels
        const communeLabels = [
            { name: "Bruxelles", lat: 50.8467, lng: 4.3517, tier: "tourist_heavy" },
            { name: "Ixelles", lat: 50.8275, lng: 4.3697, tier: "mixed" },
            { name: "Saint-Gilles", lat: 50.8261, lng: 4.3456, tier: "diaspora_hub" },
            { name: "Etterbeek", lat: 50.8333, lng: 4.3833, tier: "eu_bubble" },
            { name: "Schaerbeek", lat: 50.8653, lng: 4.3778, tier: "diaspora_hub" },
            { name: "Anderlecht", lat: 50.8333, lng: 4.3072, tier: "underexplored" },
            { name: "Molenbeek", lat: 50.8547, lng: 4.3286, tier: "diaspora_hub" },
            { name: "Saint-Josse", lat: 50.8553, lng: 4.3703, tier: "diaspora_hub" },
            { name: "Uccle", lat: 50.8000, lng: 4.3333, tier: "local_foodie" },
            { name: "Forest", lat: 50.8103, lng: 4.3242, tier: "underexplored" },
            { name: "Woluwe-St-Lambert", lat: 50.8417, lng: 4.4333, tier: "local_foodie" },
            { name: "Woluwe-St-Pierre", lat: 50.8333, lng: 4.4500, tier: "local_foodie" },
            { name: "Auderghem", lat: 50.8167, lng: 4.4333, tier: "local_foodie" },
            { name: "Watermael", lat: 50.7958, lng: 4.4125, tier: "local_foodie" },
            { name: "Evere", lat: 50.8667, lng: 4.4000, tier: "underexplored" },
            { name: "Jette", lat: 50.8792, lng: 4.3250, tier: "underexplored" },
            { name: "Ganshoren", lat: 50.8750, lng: 4.3083, tier: "underexplored" },
            { name: "Koekelberg", lat: 50.8625, lng: 4.3292, tier: "underexplored" },
            { name: "Berchem", lat: 50.8667, lng: 4.2917, tier: "underexplored" }
        ];

        // Add commune labels to map
        function addCommuneLabels() {
            communeLabelsLayer.clearLayers();

            communeLabels.forEach(commune => {
                const tierColors = {
                    'tourist_heavy': '#f87171',
                    'diaspora_hub': '#f59e0b',
                    'local_foodie': '#4ade80',
                    'underexplored': '#a78bfa',
                    'eu_bubble': '#60a5fa',
                    'mixed': '#94a3b8'
                };
                const color = tierColors[commune.tier] || '#888';

                const label = L.divIcon({
                    className: 'commune-label',
                    html: `<div style="color: #5f6368; text-shadow: 0 1px 2px rgba(255,255,255,0.9), 0 0 4px rgba(255,255,255,0.8); font-weight: 500; font-size: 11px; white-space: nowrap; text-transform: uppercase; letter-spacing: 1px;">${commune.name}</div>`,
                    iconSize: [140, 24],
                    iconAnchor: [70, 12]
                });

                L.marker([commune.lat, commune.lng], { icon: label, interactive: false })
                    .addTo(communeLabelsLayer);
            });
        }

        // Show/hide labels based on zoom level
        map.on('zoomend', function() {
            const zoom = map.getZoom();
            if (zoom >= 12 && zoom <= 15) {
                if (!map.hasLayer(communeLabelsLayer)) {
                    communeLabelsLayer.addTo(map);
                }
            } else if (zoom < 12) {
                if (map.hasLayer(communeLabelsLayer)) {
                    map.removeLayer(communeLabelsLayer);
                }
            }
        });

        addCommuneLabels();

        let restaurants = [];
        let currentFilter = 'all';

        // Day names to match opening_hours format
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function getTodayIndex() {
            return new Date().getDay(); // 0 = Sunday
        }

        function generateHoursHtml(openingHours) {
            if (!openingHours || openingHours.length === 0) {
                return '';
            }

            const todayIndex = getTodayIndex();
            const todayName = dayNames[todayIndex];

            // Find today's hours
            let todayHours = openingHours.find(h => h && h.startsWith(todayName));
            let statusText = 'Hours unknown';
            let statusClass = 'unknown';

            if (todayHours) {
                const hoursPart = todayHours.split(': ')[1] || '';
                if (hoursPart.toLowerCase().includes('closed')) {
                    statusText = 'Closed today';
                    statusClass = 'closed';
                } else {
                    statusText = `Today: ${hoursPart}`;
                    statusClass = 'open';
                }
            }

            // Build the hours list with today highlighted
            const hoursListHtml = openingHours.map(h => {
                if (!h) return '';
                const isToday = h.startsWith(todayName);
                const isClosed = h.toLowerCase().includes('closed');
                let classes = [];
                if (isToday) classes.push('today');
                if (isClosed) classes.push('closed');
                return `<div class="${classes.join(' ')}">${h}</div>`;
            }).join('');

            return `
                <div class="popup-hours">
                    <div class="popup-hours-header" onclick="toggleHours(this)">
                        <span class="popup-hours-toggle">‚ñ∂</span>
                        <span class="hours-status-dot ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                    <div class="popup-hours-list">
                        ${hoursListHtml}
                    </div>
                </div>
            `;
        }

        function toggleHours(header) {
            const toggle = header.querySelector('.popup-hours-toggle');
            const list = header.nextElementSibling;
            toggle.classList.toggle('expanded');
            list.classList.toggle('show');
        }

        function getOpenStatus(openingHours) {
            if (!openingHours || openingHours.length === 0) {
                return { status: 'unknown', text: '' };
            }

            const todayIndex = getTodayIndex();
            const todayName = dayNames[todayIndex];
            const todayHours = openingHours.find(h => h && h.startsWith(todayName));

            if (!todayHours) {
                return { status: 'unknown', text: '' };
            }

            const hoursPart = todayHours.split(': ')[1] || '';
            if (hoursPart.toLowerCase().includes('closed')) {
                return { status: 'closed', text: 'Closed today' };
            }

            return { status: 'open', text: hoursPart };
        }

        function getMarkerColor(restaurant) {
            const score = restaurant.brussels_score || 0;
            // Based on percentile distribution for meaningful differentiation:
            // Top 5% (>=0.64), Top 15% (>=0.56), Top 35% (>=0.45), Top 75% (>=0.25)
            if (score >= 0.64) return '#059669';  // Emerald - top 5% (must try)
            if (score >= 0.56) return '#10b981';  // Green - top 15% (recommended)
            if (score >= 0.45) return '#6366f1';  // Indigo - top 35% (above average)
            if (score >= 0.25) return '#94a3b8';  // Slate gray - top 75% (average)
            return '#64748b';  // Dark slate - bottom 25% (below average)
        }

        function getHexColor(cluster) {
            const colors = {
                'Elite': '#4ade80',
                'Strong': '#60a5fa',
                'Everyday': '#fbbf24',
                'Emerging': '#a78bfa'
            };
            return colors[cluster] || '#666';
        }

        function getScoreExplanation(restaurant) {
            const explanations = [];

            // Residual explanation (beating expected rating)
            if (restaurant.residual !== undefined && restaurant.residual !== null) {
                const residualPct = Math.abs(restaurant.residual * 100).toFixed(0);
                if (restaurant.residual > 0.25) {
                    explanations.push(`<span class="explain-positive">üíé Underrated: +${residualPct}% above expected</span>`);
                } else if (restaurant.residual > 0.1) {
                    explanations.push(`<span class="explain-positive">‚¨ÜÔ∏è Above expected (+${residualPct}%)</span>`);
                } else if (restaurant.residual < -0.2) {
                    explanations.push(`<span class="explain-negative">‚¨áÔ∏è Below expected (-${residualPct}%)</span>`);
                }
            }

            // Local street bonus
            if (restaurant.local_street) {
                explanations.push(`<span class="explain-positive">üìç ${restaurant.local_street} (local favorite)</span>`);
            }

            // UNIFIED SCARCITY - build a combined explanation
            // Scarcity = hard to access = likely a local gem
            if (restaurant.score_scarcity_bonus > 0.02) {
                const scarcityParts = [];

                // Hours scarcity
                if (restaurant.closes_early && restaurant.typical_close_hour) {
                    if (restaurant.typical_close_hour <= 16) {
                        scarcityParts.push("lunch only");
                    } else if (restaurant.typical_close_hour <= 20) {
                        scarcityParts.push(`closes ${restaurant.typical_close_hour}:00`);
                    }
                }

                // Days scarcity
                if (restaurant.days_open_count && restaurant.days_open_count <= 5) {
                    scarcityParts.push(`${restaurant.days_open_count} days/week`);
                }

                // Schedule scarcity
                if (restaurant.weekdays_only) {
                    scarcityParts.push("weekdays only");
                } else if (restaurant.closed_sunday) {
                    scarcityParts.push("closed Sundays");
                }

                // Rare cuisine
                if (restaurant.is_rare_cuisine) {
                    scarcityParts.push("rare cuisine");
                }

                // Build the scarcity message
                if (scarcityParts.length > 0) {
                    const scarcityLevel = restaurant.score_scarcity_bonus > 0.08 ? "üîí Exclusive" : "‚ú® Scarce";
                    explanations.push(`<span class="explain-positive">${scarcityLevel}: ${scarcityParts.join(", ")}</span>`);
                } else if (restaurant.rating >= 4.5 && restaurant.review_count <= 300) {
                    // Review-based scarcity only
                    explanations.push(`<span class="explain-positive">üîí Local gem (not over-hyped)</span>`);
                }
            }

            // Tourist trap penalty
            if (restaurant.score_tourist_penalty !== undefined && restaurant.score_tourist_penalty !== null) {
                if (restaurant.score_tourist_penalty < -0.05) {
                    explanations.push(`<span class="explain-negative">üö∂ Tourist area penalty</span>`);
                }
            }

            // Tier-based explanations
            if (restaurant.tier) {
                if (restaurant.tier === 'underexplored') {
                    explanations.push(`<span class="explain-positive">üîç Hidden gem in underexplored area</span>`);
                } else if (restaurant.tier === 'tourist_trap') {
                    explanations.push(`<span class="explain-negative">‚ö†Ô∏è Tourist trap zone</span>`);
                } else if (restaurant.tier === 'eu_bubble') {
                    explanations.push(`<span class="explain-neutral">üá™üá∫ EU quarter area</span>`);
                }
            }

            // Cold start (new promising place)
            if (restaurant.review_count && restaurant.review_count < 50 && restaurant.rating >= 4.5) {
                explanations.push(`<span class="explain-positive">üÜï Promising new spot (${restaurant.review_count} reviews)</span>`);
            }

            // Independent restaurant bonus
            if (restaurant.is_chain === false || restaurant.is_chain === 0) {
                // Only mention if it's a notable factor
                if (restaurant.brussels_score > 0.4) {
                    explanations.push(`<span class="explain-positive">üè† Independent restaurant</span>`);
                }
            } else if (restaurant.is_chain === true || restaurant.is_chain === 1) {
                explanations.push(`<span class="explain-negative">üîó Chain restaurant</span>`);
            }

            // High rating with high review count (genuinely popular)
            if (restaurant.rating >= 4.5 && restaurant.review_count > 500) {
                explanations.push(`<span class="explain-positive">‚≠ê High rating despite popularity</span>`);
            }

            // Low confidence warning for few reviews
            if (restaurant.review_count && restaurant.review_count < 20) {
                explanations.push(`<span class="explain-neutral">‚ö†Ô∏è Low confidence (only ${restaurant.review_count} reviews)</span>`);
            }

            return explanations.slice(0, 4); // Limit to top 4 explanations
        }

        // Professional food map icons - 18px with refined color palette
        // Colors: Gold (must try), Emerald (recommended), Blue (above avg), Gray (average)
        function createPinIcon(color, isSelected = false, tier = 'average') {
            const size = 18;

            // Professional tier colors - optimized for map visibility
            const tierColors = {
                'must_try': '#FFD700',      // Gold - highest quality
                'recommended': '#2ECC71',   // Emerald Green - positive action
                'above_average': '#3498DB', // Bright Blue - above norm
                'average': '#95A5A6'        // Concrete Gray - minimal noise
            };

            const iconColor = tierColors[tier] || tierColors['average'];

            // Clean icons with appropriate symbols per tier
            const tierIcons = {
                // Crown icon (Must try) - gold with crown symbol
                'must_try': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M5 12h8l-1-5-2 2-1-3-1 3-2-2-1 5z" fill="white"/>
                    <rect x="5" y="12" width="8" height="1.5" rx="0.5" fill="white"/>
                `,
                // Heart icon (Recommended) - green with heart
                'recommended': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M9 13l-4-4c-1-1-1-2.5 0-3.5s2.5-1 3.5 0l.5.5.5-.5c1-1 2.5-1 3.5 0s1 2.5 0 3.5l-4 4z" fill="white"/>
                `,
                // Fork & knife (Above average) - blue with utensils
                'above_average': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <path d="M6 5v4l1 .5V14h1V9.5L9 9V5H8v3h-.5V5H7v3h-.5V5H6zm5 0c0 1.5.5 2.5 1.5 3v6h1V8c1-.5 1.5-1.5 1.5-3h-1v2h-.5V5h-1v2h-.5V5h-1z" fill="white"/>
                `,
                // Simple dot (Average) - gray with minimal marker
                'average': `
                    <circle cx="9" cy="9" r="8.5" fill="${iconColor}"/>
                    <circle cx="9" cy="9" r="2.5" fill="white"/>
                `
            };

            if (isSelected) {
                // Selected: larger (26px) with shadow and bounce effect
                const pinSize = 26;
                const scale = pinSize / size;
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="${pinSize}" height="${pinSize}" style="filter: drop-shadow(0 3px 4px rgba(0,0,0,0.35));">
                        ${tierIcons[tier] || tierIcons['average']}
                    </svg>
                `;
                return L.divIcon({
                    className: 'pin-marker pin-selected',
                    html: svg,
                    iconSize: [pinSize, pinSize],
                    iconAnchor: [pinSize / 2, pinSize / 2],
                    popupAnchor: [0, -pinSize / 2]
                });
            } else {
                // Default: 18px icon
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="${size}" height="${size}" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
                        ${tierIcons[tier] || tierIcons['average']}
                    </svg>
                `;
                return L.divIcon({
                    className: 'pin-marker pin-dot',
                    html: svg,
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2],
                    popupAnchor: [0, -size / 2]
                });
            }
        }

        // Get tier from brussels_score
        function getTierFromScore(score) {
            if (score >= 0.6) return 'must_try';
            if (score >= 0.45) return 'recommended';
            if (score >= 0.3) return 'above_average';
            return 'average';
        }

        let selectedMarker = null;

        function createMarker(restaurant) {
            const color = getMarkerColor(restaurant);
            const tier = getTierFromScore(restaurant.brussels_score || 0);

            // All markers start as small dots with tier-specific icon
            const marker = L.marker([restaurant.lat, restaurant.lng], {
                icon: createPinIcon(color, false, tier)
            });

            // Store color, tier and restaurant data for selection
            marker.restaurantColor = color;
            marker.restaurantTier = tier;
            marker.restaurantData = restaurant;

            const commune = restaurant.commune || 'Unknown';
            const neighborhood = restaurant.neighborhood ? ` (${restaurant.neighborhood})` : '';

            // Generate score explanation
            const explanations = getScoreExplanation(restaurant);
            const explanationHtml = explanations.length > 0
                ? `<div class="popup-explanation">
                    <div class="explain-title">Why it's ranked:</div>
                    ${explanations.join('<br>')}
                   </div>`
                : '';

            // Generate opening hours HTML
            const hoursHtml = generateHoursHtml(restaurant.opening_hours);

            // Generate guide badges - show ALL recognitions (not mutually exclusive)
            let guideBadges = '';
            if (restaurant.michelin_stars >= 2) {
                guideBadges += `<span class="guide-badge michelin-2">${'‚≠ê'.repeat(restaurant.michelin_stars)} Michelin</span>`;
            } else if (restaurant.michelin_stars === 1) {
                guideBadges += `<span class="guide-badge michelin">‚≠ê Michelin</span>`;
            } else if (restaurant.bib_gourmand) {
                guideBadges += `<span class="guide-badge bib-gourmand">Bib Gourmand</span>`;
            }
            // Gault & Millau is independent - can be shown alongside Michelin/Bib
            if (restaurant.gault_millau) {
                guideBadges += `<span class="guide-badge gault-millau">Gault&Millau</span>`;
            }
            const badgesHtml = guideBadges ? `<div class="guide-badges">${guideBadges}</div>` : '';

            const score = restaurant.brussels_score || 0;

            marker.bindPopup(`
                <div class="popup-name">${restaurant.name}</div>
                ${badgesHtml}
                <div class="popup-commune">${commune}${neighborhood}</div>
                <div class="popup-cuisine">${restaurant.cuisine || 'Restaurant'}</div>
                <div class="popup-stats">
                    <span>‚òÖ ${restaurant.rating?.toFixed(1) || 'N/A'}</span>
                    <span>${restaurant.review_count || 0} reviews</span>
                    ${score ? `<span>Score: ${score.toFixed(2)}</span>` : ''}
                </div>
                ${hoursHtml}
                ${explanationHtml}
                ${restaurant.google_maps_url ?
                    `<a href="${restaurant.google_maps_url}" target="_blank" class="popup-link">View on Google Maps ‚Üí</a>` : ''
                }
            `);

            // On click, expand this marker to full pin
            marker.on('click', function() {
                // Reset previous selected marker
                if (selectedMarker && selectedMarker !== this) {
                    selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                }
                // Expand this marker
                this.setIcon(createPinIcon(this.restaurantColor, true, this.restaurantTier));
                selectedMarker = this;
            });

            return marker;
        }

        // Click on map to deselect marker
        map.on('click', function(e) {
            if (selectedMarker && !e.originalEvent.target.closest('.pin-marker')) {
                selectedMarker.setIcon(createPinIcon(selectedMarker.restaurantColor, false, selectedMarker.restaurantTier));
                selectedMarker = null;
            }
        });

        // Helper function to check if restaurant is open on a specific day
        function isOpenOnDay(openingHours, day) {
            if (!openingHours || openingHours.length === 0) return true; // Include unknowns

            const dayHours = openingHours.find(h => h && h.startsWith(day));
            if (!dayHours) return false;

            if (dayHours.toLowerCase().includes('closed')) return false;

            return true;
        }

        // Helper function to check if restaurant is open at a specific time
        function isOpenAtTime(openingHours, day, hour) {
            if (!openingHours || openingHours.length === 0) return true; // Include unknowns

            const dayHours = openingHours.find(h => h && h.startsWith(day));
            if (!dayHours) return false;

            if (dayHours.toLowerCase().includes('closed')) return false;

            // Parse hours like "Monday: 12:00 ‚Äì 2:30 PM, 6:00 ‚Äì 10:00 PM"
            const hoursPart = dayHours.split(': ')[1];
            if (!hoursPart) return true;

            // Split by comma for multiple time ranges
            const ranges = hoursPart.split(',').map(r => r.trim());

            for (const range of ranges) {
                // Parse time range - handle various formats
                // Google format: "6:30 ‚Äì 9:30 PM" (PM applies to BOTH times)
                const match = range.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?\s*[‚Äì-]\s*(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
                if (!match) continue;

                let startHour = parseInt(match[1]);
                const startAMPM = match[3]?.toUpperCase();
                let endHour = parseInt(match[4]);
                const endAMPM = match[6]?.toUpperCase();

                // If only end has AM/PM, it applies to both (Google format)
                // e.g., "6:30 ‚Äì 9:30 PM" means 6:30 PM ‚Äì 9:30 PM
                const effectiveStartAMPM = startAMPM || endAMPM;
                const effectiveEndAMPM = endAMPM || startAMPM;

                // Convert to 24h format
                if (effectiveStartAMPM === 'PM' && startHour !== 12) startHour += 12;
                if (effectiveStartAMPM === 'AM' && startHour === 12) startHour = 0;
                if (effectiveEndAMPM === 'PM' && endHour !== 12) endHour += 12;
                if (effectiveEndAMPM === 'AM' && endHour === 12) endHour = 0;

                // Handle overnight hours (e.g., 6 PM - 2 AM)
                if (endHour < startHour) endHour += 24;

                if (hour >= startHour && hour < endHour) return true;
            }

            return false;
        }

        async function loadRestaurants() {
            const params = new URLSearchParams();

            const search = document.getElementById('search').value;
            const commune = document.getElementById('commune-filter').value;
            const cuisine = document.getElementById('cuisine-filter').value;
            const minRating = document.getElementById('rating-filter').value;
            const priceLevel = document.getElementById('price-filter').value;
            const sortBy = document.getElementById('sort-filter').value;
            const venueType = document.getElementById('venue-filter').value;
            const guideFilter = document.getElementById('guide-filter').value;
            const dayFilter = document.getElementById('day-filter').value;
            const timeFilter = document.getElementById('time-filter').value;

            if (search) params.append('search', search);
            if (commune !== 'all') params.append('commune', commune);
            if (cuisine !== 'all') params.append('cuisine', cuisine);
            if (minRating) params.append('min_rating', minRating);
            if (priceLevel) params.append('price_level', priceLevel);
            if (venueType !== 'all') params.append('venue_type', venueType);
            if (guideFilter) params.append('guide', guideFilter);
            if (dayFilter) params.append('open_day', dayFilter);
            params.append('sort_by', sortBy);

            if (currentFilter === 'brussels_gems') params.append('brussels_gems', 'true');
            if (currentFilter === 'underrated') params.append('gems_only', 'true');
            if (currentFilter === 'diaspora') params.append('diaspora_only', 'true');

            try {
                const response = await fetch(`/api/restaurants?${params}`);
                let data = await response.json();

                // Client-side day/time filtering (more accurate than server-side)
                if (dayFilter) {
                    if (timeFilter) {
                        // Filter by day AND specific time
                        data = data.filter(r => isOpenAtTime(r.opening_hours, dayFilter, parseInt(timeFilter)));
                    } else {
                        // Filter by day only (any time that day)
                        data = data.filter(r => isOpenOnDay(r.opening_hours, dayFilter));
                    }
                }

                restaurants = data;

                updateMarkers();
                updateList();
                updateStats();
            } catch (error) {
                console.error('Error loading restaurants:', error);
                document.getElementById('restaurant-list').innerHTML =
                    '<div class="loading">Error loading data</div>';
            }
        }

        function updateMarkers() {
            markersLayer.clearLayers();

            // Sort by score ascending so higher-scored restaurants are rendered last (on top)
            const sorted = [...restaurants].sort((a, b) =>
                (a.brussels_score || 0) - (b.brussels_score || 0)
            );

            // On mobile, batch marker creation for better performance
            if (isMobile && sorted.length > 100) {
                // Add markers in chunks to avoid blocking UI
                const chunkSize = 50;
                let index = 0;

                function addChunk() {
                    const chunk = sorted.slice(index, index + chunkSize);
                    chunk.forEach(restaurant => {
                        if (restaurant.lat && restaurant.lng) {
                            const marker = createMarker(restaurant);
                            markersLayer.addLayer(marker);
                        }
                    });
                    index += chunkSize;
                    if (index < sorted.length) {
                        requestAnimationFrame(addChunk);
                    }
                }
                addChunk();
            } else {
                sorted.forEach(restaurant => {
                    if (restaurant.lat && restaurant.lng) {
                        const marker = createMarker(restaurant);
                        markersLayer.addLayer(marker);
                    }
                });
            }
        }

        function updateList() {
            const listEl = document.getElementById('restaurant-list');
            const countEl = document.getElementById('results-count');

            countEl.textContent = `${restaurants.length} restaurants`;

            if (restaurants.length === 0) {
                listEl.innerHTML = '<div class="loading">No restaurants found</div>';
                return;
            }

            listEl.innerHTML = restaurants.slice(0, 50).map(r => {
                const score = r.brussels_score?.toFixed(2) || '';
                const isUnderexplored = r.tier === 'underexplored';
                const commune = r.commune || '';
                const openStatus = getOpenStatus(r.opening_hours);

                // Build hours display for card
                let hoursHtml = '';
                if (openStatus.status !== 'unknown') {
                    hoursHtml = `
                        <div class="restaurant-hours">
                            <div class="restaurant-hours-status">
                                <span class="hours-status-dot ${openStatus.status}"></span>
                                <span>${openStatus.status === 'closed' ? 'Closed today' : openStatus.text}</span>
                            </div>
                        </div>
                    `;
                }

                // Guide badges for cards - show ALL recognitions (not mutually exclusive)
                let cardGuideBadges = '';
                if (r.michelin_stars >= 2) {
                    cardGuideBadges += `<span class="guide-badge michelin-2">${'‚≠ê'.repeat(r.michelin_stars)} Michelin</span>`;
                } else if (r.michelin_stars === 1) {
                    cardGuideBadges += `<span class="guide-badge michelin">‚≠ê Michelin</span>`;
                } else if (r.bib_gourmand) {
                    cardGuideBadges += `<span class="guide-badge bib-gourmand">Bib Gourmand</span>`;
                }
                // Gault & Millau is independent - can be shown alongside Michelin/Bib
                if (r.gault_millau) {
                    cardGuideBadges += `<span class="guide-badge gault-millau">Gault&Millau</span>`;
                }

                return `
                    <div class="restaurant-card" onclick="flyTo(${r.lat}, ${r.lng})">
                        <div class="restaurant-header">
                            <div class="restaurant-name">${r.name}</div>
                            <div class="restaurant-badges">
                                ${cardGuideBadges}
                                ${isUnderexplored ? '<span class="badge badge-underexplored">Hidden</span>' : ''}
                            </div>
                        </div>
                        <div class="restaurant-location">${commune}</div>
                        <div class="restaurant-cuisine">${r.cuisine || 'Restaurant'}</div>
                        <div class="restaurant-meta">
                            <span class="restaurant-rating">
                                <span class="star">‚òÖ</span>
                                ${r.rating?.toFixed(1) || 'N/A'}
                            </span>
                            <span>${r.review_count || 0} reviews</span>
                            <span>${'‚Ç¨'.repeat(r.price_numeric || 2)}</span>
                        </div>
                        ${hoursHtml}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('total-restaurants').textContent = restaurants.length;
            document.getElementById('total-gems').textContent =
                restaurants.filter(r => (r.brussels_score || 0) >= 0.55).length;

            const cuisines = new Set(restaurants.map(r => r.cuisine).filter(Boolean));
            document.getElementById('total-cuisines').textContent = cuisines.size;
        }

        function flyTo(lat, lng) {
            map.flyTo([lat, lng], 16);
        }

        async function loadHexagons() {
            try {
                const response = await fetch('/api/hexagons');
                const geojson = await response.json();

                hexagonsLayer.clearLayers();

                L.geoJSON(geojson, {
                    style: feature => ({
                        fillColor: getHexColor(feature.properties.cluster_label),
                        color: '#000',
                        weight: 1,
                        fillOpacity: 0.5
                    }),
                    onEachFeature: (feature, layer) => {
                        const p = feature.properties;
                        layer.bindPopup(`
                            <div class="popup-name">${p.cluster_label} Area</div>
                            <div class="popup-stats">
                                <span>Restaurants: ${p.restaurant_count}</span>
                                <span>Avg: ${p.mean_rating}‚òÖ</span>
                            </div>
                        `);
                    }
                }).addTo(hexagonsLayer);
            } catch (error) {
                console.error('Error loading hexagons:', error);
            }
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', debounce(loadRestaurants, 300));
        document.getElementById('commune-filter').addEventListener('change', loadRestaurants);
        document.getElementById('cuisine-filter').addEventListener('change', loadRestaurants);
        document.getElementById('venue-filter').addEventListener('change', loadRestaurants);
        document.getElementById('rating-filter').addEventListener('change', loadRestaurants);
        document.getElementById('price-filter').addEventListener('change', loadRestaurants);
        document.getElementById('sort-filter').addEventListener('change', loadRestaurants);
        document.getElementById('guide-filter').addEventListener('change', loadRestaurants);
        document.getElementById('day-filter').addEventListener('change', loadRestaurants);
        document.getElementById('time-filter').addEventListener('change', loadRestaurants);

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`show-${filter === 'all' ? 'all' : filter.replace('_', '-')}`).classList.add('active');
            loadRestaurants();
        }

        document.getElementById('show-all').addEventListener('click', () => setFilter('all'));
        document.getElementById('show-brussels-gems').addEventListener('click', () => setFilter('brussels_gems'));
        document.getElementById('show-underrated').addEventListener('click', () => setFilter('underrated'));

        document.getElementById('layer-markers').addEventListener('click', () => {
            document.getElementById('layer-markers').classList.add('active');
            document.getElementById('layer-hexagons').classList.remove('active');
            document.getElementById('legend-markers').style.display = 'block';
            document.getElementById('legend-hexagons').style.display = 'none';
            map.removeLayer(hexagonsLayer);
            map.addLayer(markersLayer);
        });

        document.getElementById('layer-hexagons').addEventListener('click', () => {
            document.getElementById('layer-hexagons').classList.add('active');
            document.getElementById('layer-markers').classList.remove('active');
            document.getElementById('legend-hexagons').style.display = 'block';
            document.getElementById('legend-markers').style.display = 'none';
            map.removeLayer(markersLayer);
            map.addLayer(hexagonsLayer);
            loadHexagons();
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        loadRestaurants();

        // Mobile tab navigation
        const container = document.querySelector('.container');
        const mobileTabs = document.querySelectorAll('.mobile-tab');

        function switchTab(tabName) {
            // Update container class
            container.classList.remove('tab-map', 'tab-search', 'tab-results');
            container.classList.add(`tab-${tabName}`);

            // Update active tab
            mobileTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Resize map when switching to map tab
            if (tabName === 'map') {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        mobileTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        // Start with map tab on mobile
        if (window.innerWidth <= 768) {
            container.classList.add('tab-map');
            setTimeout(() => map.invalidateSize(), 100);
        }

        // Info popup functionality
        const infoBtn = document.getElementById('info-btn');
        const infoOverlay = document.getElementById('info-overlay');
        const infoClose = document.getElementById('info-close');

        infoBtn.addEventListener('click', () => {
            infoOverlay.classList.add('active');
        });

        infoClose.addEventListener('click', () => {
            infoOverlay.classList.remove('active');
        });

        infoOverlay.addEventListener('click', (e) => {
            if (e.target === infoOverlay) {
                infoOverlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
